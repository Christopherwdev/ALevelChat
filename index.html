<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Past Paper Score Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ApexCharts CDN for advanced charting -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #007aff;
            --color-90: #b7e1cd; /* Green for 90%+ */
            --color-80: #b7e1cd; /* Green for 80%+ */
            --color-70: #fce8b3; /* Amber for 70%+ */
            --color-50: #fcd3b3; /* Light orange for 50%+ */
            --color-fail: #f4c7c2; /* Red for Fail */
        }
        html, body {
            height: 100%;
            overflow: hidden; /* Prevent body scroll, table will scroll */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
            color: #333;
        }
        .table-container {
            width: 100%;
            height: calc(100vh - 80px); /* Adjust based on header height */
            overflow: auto;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            margin-bottom: 30px;
            position: relative; /* Needed for absolute positioning of message */
        }
        .table-container::-webkit-scrollbar {
            display: none;
        }
        table {
            border-collapse: separate;
            border-spacing: 0;
            width: 100%;
        }
        /* Apply full border to all cells */
        th, td {
            border: 1px solid #e2e8f0;
            padding: 0;
            white-space: nowrap;
            text-align: center;
            position: relative;
        }

        td {
             /* max-width: 1000px; */
                    /* max-width: 200px; */
             min-width:100px;
        }

            td:first-child {
      
             min-width:170px;
        }
        
        th {
            background-color: #fff;
            position: sticky;
            top: 0;
            z-index: 10; /* Z-index for sticky header row */
            padding: 0.5rem 0.75rem; /* Reduced padding */
            font-weight: 600;
            color: #4a5568;
            
            
        }
        /* Sticky first column (Year / Series) */
        td:first-child {
            position: sticky;
            left: 0;
            z-index: 11; /* Z-index for sticky left column, higher than top row */
            background-color: #fff;
            padding: 0.25rem 0.75rem; /* Reduced padding */
            font-weight: 500;
           
        }
        /* Top-left corner cell (intersection of sticky row and column) */
        th:first-child {
            position: sticky;
            left: 0;
            z-index: 20; /* Highest z-index for the corner cell */
            background-color: #fff;
            padding: 0; /* Remove padding from this TH, button inside will have padding */
        }
        /* This style is now applied to the button *inside* the th:first-child for the table */
        #table-head th:first-child button { /* Specificity to target button within the table header */
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem; /* Match other header text size */
            font-weight: 600;
            color: #4a5568;
            background-color: #fff;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
            border-radius: 0.5rem 0 0 0; /* Match parent's border radius top-left */
        }
        #table-head th:first-child button:hover {
            background-color: #f0f0f0;
        }

        .score-cell {
            min-width: 10px; /* Ensures it doesn't shrink smaller */
            height: 32px; /* Smaller height */
            line-height: 32px;
            outline: none;
            transition: background-color 0.3s ease;
            display: flex; /* Use flexbox to center content */
            align-items: center;
            justify-content: center;
            font-size: 0.875rem; /* Smaller font size */
        }
        .score-cell:focus {
            box-shadow: inset 0 0 0 2px black;
        }
        .score-cell.disabled {
            background-color: #e9ecef;
            cursor: not-allowed;
            color: #6c757d;
        }
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #0056b3;
        }
        /* Custom Checkbox */
        .custom-checkbox:checked {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        /* Hide scrollbar for Chrome, Safari and Opera */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        /* Hide scrollbar for IE, Edge and Firefox */
        .no-scrollbar {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }

        /* Modal specific styles */
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
            max-width: 90vw;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        .modal-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e2e8f0;
        }
        .modal-body {
            padding: 1.5rem;
            flex-grow: 1;
            overflow-y: auto;
        }
        .modal-footer {
            padding: 1rem;
            background-color: #f8f9fa;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: flex-end;
            border-radius: 0 0 0.5rem 0.5rem;
        }

        /* Graph specific styles in overlay */
        .overlay-graphs-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 0.75rem;
            width: 100%;
        }
        .overlay-graph {
            flex-shrink: 0; /* Prevent shrinking */
            width: 50%; /* Fixed width for small graphs */
            height: 90px; /* Fixed height for small graphs */
            border-radius: 0.25rem;
            padding: 0px 5px;
            background-color: #fcfcfc;
            align-items: start;
        }
        .overlay-graph-title {
            font-size: 12px;
            font-weight: 600;
            text-align: left;
            margin-bottom: 2px;
            color: #4a5568;
            justify-content: space-between;
        }
        .progress-bar-container {
            width: 100%;
            height: 10px;
            background-color: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
            margin: 5px auto 0;
        }
        .progress-bar {
            height: 100%;
            background-color: var(--primary-color);
            transition: width 0.3s ease-in-out;
            border-radius: 5px;
        }
        #bottom-actions {
           /* overflow: auto; */
           overflow: hidden;
        }
        #bottom-actions::-webkit-scrollbar {
            display: none;
        }

        /* Styling for the new mean scores row */
        .mean-score-row {
            font-weight: bold;
            background-color: #e9e9e9; /* Light grey background for emphasis */
            position: sticky;
            bottom: 0;
            z-index: 15; /* Ensure it stays above other content but below header/sticky column */
        }
        .mean-score-row td {
            background-color: #e9e9e9; /* Ensure cells also have the background */
        }
        .mean-score-row td:first-child {
            background-color: #e9e9e9; /* And the sticky first column cell */
        }

        /* ApexCharts specific styling to ensure it fits well */
        #chart-skewed-dist {
            max-width: 100%; /* Ensure chart is responsive within its container */
            margin: 0; /* Remove default margin */
            padding: 0;
          
        }
        /* Styles for exam level selector */
        #exam-level-select {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-weight: 500;
            color: #4a5568;
            background-color: #e2e8f0; /* Light gray background */
            transition: all 0.2s ease-in-out;
            border: 1px solid #cbd5e0;
        }
        #exam-level-select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.2);
        }

    </style>

   
</head>
<body class="antialiased">

    <div id="app-container" class="w-full h-full flex flex-col box-border">

        <header class="flex justify-between items-center p-4 h-[80px]">
            <div id="left-header-content">
                <h1 class="text-2xl font-bold text-gray-800" id="header-date"></h1>
                <p class="text-xs text-gray-500 mt-1">Data saved locally in your browser</p>
            </div>
            <script src="header.js"></script>
            <div class="flex items-center space-x-2">
                <!-- Exam Level Select Dropdown -->
                <select id="exam-level-select" class="w-[150px] p-2 text-base bg-gray-100 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary">
                    <option value="IAL">IAL</option>
                    <option value="IGCSE">IGCSE</option>
                </select>
            </div>
        </header>

        <div id="table-container" class="table-container flex-grow box-content">
            <!-- Message and Button for when no papers are selected -->
            <div id="no-papers-state" class="absolute inset-0 flex flex-col items-center justify-center text-gray-500 text-lg hidden">
                <p class="mb-4">No papers selected. Click 'Select Papers' to get started.</p>
                <button id="select-papers-intro-btn" class="btn-primary flex items-center gap-2 px-6 py-3 text-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    <span>Select Papers</span>
                </button>
            </div>
            
            <table id="scores-table">
                <thead id="table-head"></thead>
                <tbody id="table-body"></tbody>
                <tfoot id="table-foot"></tfoot>
            </table>
        </div>

        <div id="bottom-actions" class="fixed p-4 bg-white rounded-lg shadow-lg z-20 transform-gpu opacity-0 invisible translate-y-20 flex flex-col items-center w-[290px] h-[150px] max-w-sm cursor-grab pt-6">
            <button id="close-bottom-actions-btn" class="absolute top-2 right-2 text-gray-500 hover:text-gray-700 rounded-full p-1 hover:bg-gray-100 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd" />
                </svg>
            </button>
            <div id="active-cell-info" class="leading-[1.2em] text-gray-700 text-sm mb-[15px] font-semibold pt-0 flex-col w-full"><span>Edexcel IAL</span><br><br><span style="font-size: 30px;">Loading...</span></div>
            <div class="flex space-x-2 mb-2 w-full">
                <button id="goto-qp-btn" class="btn-primary w-[100%]">Question</button>
                <button id="goto-ms-btn" class="btn-primary w-[100%] bg-gray-500 hover:bg-gray-600">Answer</button>
                </div>
            <div id="paper-graphs" class="overlay-graphs-container w-full invisible">
                </div>
        </div>
    </div>

    <!-- Main Modal for Subject Selection and Year Range -->
    <div id="modal-container" class="fixed inset-0 modal-overlay z-50 hidden">
        <div class="modal-content w-full max-w-4xl">
            <div class="modal-header">
                <h2 class="text-2xl font-bold text-gray-800">Select Subjects and Papers</h2>
                <p class="text-gray-600">Choose the papers you want to track. Changes are saved automatically.</p>
            </div>
            <div id="modal-content-main" class="modal-body no-scrollbar">
                <!-- Subject Selection Content (existing) -->
                <div id="modal-content-subjects"></div>

                <!-- Year Range Section (moved here) -->
                <div id="year-range-section" class="mt-8 pt-6 border-t border-gray-200">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">Set Year Range</h3>
                    <div class="space-y-4">
                        <div class="flex items-center space-x-4">
                            <label for="start-year" class="block text-gray-700 w-24">Start:</label>
                            <select id="start-year" class="flex-1 border border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500"></select>
                            <select id="start-series" class="flex-1 border border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500">
                                <!-- Options populated by JS -->
                            </select>
                        </div>
                        <div class="flex items-center space-x-4">
                            <label for="end-year" class="block text-gray-700 w-24">End:</label>
                            <select id="end-year" class="flex-1 border border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500"></select>
                            <select id="end-series" class="flex-1 border border-gray-300 rounded-md p-2 focus:ring-blue-500 focus:border-blue-500">
                                <!-- Options populated by JS -->
                            </select>
                        </div>
                        <p id="year-range-error" class="text-red-500 text-sm hidden">Start date cannot be after end date.</p>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button id="close-modal-btn" class="btn-primary">Done</button>
            </div>
        </div>
    </div>


    <script>
        // --- CONFIGURATION ---
        // Using a new appId to avoid conflicts with previous localStorage data structure
        const appId = 'past-paper-tracker-app-v5'; // Changed app ID for new structure

        // IAL Specific Data
        const ialSubjectsData = {
            'Physics': { papers: ['Unit 1', 'Unit 2', 'Unit 3', 'Unit 4', 'Unit 5', 'Unit 6'] },
            'Chemistry': { papers: ['Unit 1', 'Unit 2', 'Unit 3', 'Unit 4', 'Unit 5', 'Unit 6'] },
            'Biology': { papers: ['Unit 1', 'Unit 2', 'Unit 3', 'Unit 4', 'Unit 5', 'Unit 6'] },
            'Math': { papers: ['P1', 'P2', 'P3', 'P4', 'M1', 'M2', 'M3', 'FP1', 'FP2', 'FP3', 'S1', 'S2', 'S3', 'D1', 'D2'] }
        };
        const ialPaperMaxMarks = {
            'Unit 1': 80, 'Unit 2': 80, 'Unit 4': 90, 'Unit 5': 90, 'Unit 3': 50, 'Unit 6': 50,
            'P1': 75, 'P2': 75, 'P3': 75, 'P4': 75, 'M1': 75, 'M2': 75, 'M3': 75,
            'FP1': 75, 'FP2': 75, 'FP3': 75, 'S1': 75, 'S2': 75, 'S3': 75, 'D1': 75, 'D2': 75
        };
        const ialSeries = ['Jan', 'Jun', 'Oct'];
        const ialSeriesOrder = { 'Jan': 0, 'Jun': 1, 'Oct': 2 };
        const ialMaxYearSelect = 2025;
        const ialMaxSeriesSelect = 'Jun';

        // IGCSE Specific Data
        const igcseSubjectsData = {
            'Math A': { papers: ['Paper 1', 'Paper 2'] },
            'Math B': { papers: ['Paper 1', 'Paper 2'] },
            'Physics': { papers:  ['Paper 1', 'Paper 2'] },
            'Chemistry': { papers: ['Paper 1', 'Paper 2'] },
            'Biology': { papers: ['Paper 1', 'Paper 2'] },
            'Chinese': { papers: ['Paper 1', 'Paper 2'] }
        };
        const igcsePaperMaxMarks = {
            'Paper 1F': 100, 'Paper 1H': 100, 'Paper 2F': 100, 'Paper 2H': 100, // Math
            'Paper 1': 50, 'Paper 2': 80,
            'Paper 1P': 60, 'Paper 2P': 60, 'Paper 3P': 60, 'Paper 4P': 60, // Physics
            'Paper 1C': 60, 'Paper 2C': 60, 'Paper 3C': 60, 'Paper 4C': 60, // Chemistry
            'Paper 1B': 60, 'Paper 2B': 60, 'Paper 3B': 60, 'Paper 4B': 60 // Biology
        };
        const igcseSeries = ['Jan', 'Jun', 'Nov'];
        const igcseSeriesOrder = { 'Jan': 0, 'Jun': 1, 'Nov': 2 };
        const igcseMaxYearSelect = 2025;
        const igcseMaxSeriesSelect = 'Nov'; // Max year for IGCSE, adjusted for current year

        // Editable list of disabled papers
        const disabledPapersList = [
           { examBoard: 'Edexcel', examLevel: 'IGCSE', subject: 'Chinese', series: 'Jan', paper: null, year: null },




           
         { examBoard: "Edexcel", examLevel: "IGCSE", subject: "Chinese", series: "Nov", year: 2011, paper: null },
  { examBoard: "Edexcel", examLevel: "IGCSE", subject: "Chinese", series: "Nov", year: 2012, paper: null },
  { examBoard: "Edexcel", examLevel: "IGCSE", subject: "Chinese", series: "Nov", year: 2013, paper: null },
  { examBoard: "Edexcel", examLevel: "IGCSE", subject: "Chinese", series: "Nov", year: 2014, paper: null },
  { examBoard: "Edexcel", examLevel: "IGCSE", subject: "Chinese", series: "Nov", year: 2015, paper: null },
    { examBoard: "Edexcel", examLevel: "IGCSE", subject: "Chinese", series: "Jun", year: 2015, paper: null },
  { examBoard: "Edexcel", examLevel: "IGCSE", subject: "Chinese", series: "Nov", year: 2016, paper: null },
  { examBoard: "Edexcel", examLevel: "IGCSE", subject: "Chinese", series: "Nov", year: 2017, paper: null },
  { examBoard: "Edexcel", examLevel: "IGCSE", subject: "Chinese", series: "Nov", year: 2018, paper: null },
  { examBoard: "Edexcel", examLevel: "IGCSE", subject: "Chinese", series: "Nov", year: 2019, paper: null },
  { examBoard: "Edexcel", examLevel: "IGCSE", subject: "Chinese", series: "Jun", year: 2020, paper: null },
  { examBoard: "Edexcel", examLevel: "IGCSE", subject: "Chinese", series: "Jun", year: 2021, paper: null },
  { examBoard: "Edexcel", examLevel: "IGCSE", subject: "Chinese", series: "Nov", year: 2022, paper: null },


    { examBoard: "Edexcel", examLevel: "IGCSE", subject: "Chinese", series: "Nov", year: 2022, paper: null },
      { examBoard: "Edexcel", examLevel: "IGCSE", subject: "Chinese", series: "Nov", year: 2022, paper: null },
        { examBoard: "Edexcel", examLevel: "IGCSE", subject: "Chinese", series: "Nov", year: 2022, paper: null },


  {
    "examBoard": "Edexcel",
    "examLevel": "IGCSE",
    "subject": "Math A",
    "series": "Jan",
    "year": 2011,
    "paper": null
  },
  {
    "examBoard": "Edexcel",
    "examLevel": "IGCSE",
    "subject": "Math A",
    "series": "Nov",
    "year": 2011,
    "paper": null
  },
  {
    "examBoard": "Edexcel",
    "examLevel": "IGCSE",
    "subject": "Math A",
    "series": "Nov",
    "year": 2012,
    "paper": null
  },
  {
    "examBoard": "Edexcel",
    "examLevel": "IGCSE",
    "subject": "Math A",
    "series": "Nov",
    "year": 2013,
    "paper": null
  },
  {
    "examBoard": "Edexcel",
    "examLevel": "IGCSE",
    "subject": "Math A",
    "series": "Nov",
    "year": 2014,
    "paper": null
  },
  {
    "examBoard": "Edexcel",
    "examLevel": "IGCSE",
    "subject": "Math A",
    "series": "Nov",
    "year": 2015,
    "paper": null
  },
  {
    "examBoard": "Edexcel",
    "examLevel": "IGCSE",
    "subject": "Math A",
    "series": "Nov",
    "year": 2016,
    "paper": null
  },
  {
    "examBoard": "Edexcel",
    "examLevel": "IGCSE",
    "subject": "Math A",
    "series": "Nov",
    "year": 2017,
    "paper": null
  },
  {
    "examBoard": "Edexcel",
    "examLevel": "IGCSE",
    "subject": "Math A",
    "series": "Nov",
    "year": 2018,
    "paper": null
  },
  {
    "examBoard": "Edexcel",
    "examLevel": "IGCSE",
    "subject": "Math A",
    "series": "Nov",
    "year": 2019,
    "paper": null
  },
  {
    "examBoard": "Edexcel",
    "examLevel": "IGCSE",
    "subject": "Math A",
    "series": "Jun",
    "year": 2020,
    "paper": null
  },
  {
    "examBoard": "Edexcel",
    "examLevel": "IGCSE",
    "subject": "Math A",
    "series": "Nov",
    "year": 2022,
    "paper": null
  }
        ];


        // --- STATE ---
        let appState = {
            currentMode: 'IAL', // Default mode
            modes: {
                IAL: {
                    selectedPapers: {
                        'Math': ['P1', 'P2', 'P3', 'P4'],
                        'Physics': ['Unit 1', 'Unit 2']
                    },
                    scores: {},
                    years: []
                },
                IGCSE: {
                    selectedPapers: {
                        'Math A': ['Paper 1H', 'Paper 2H'], // Changed to Math A as per updated igcseSubjectsData
                        'Chinese': ['Paper 1H']
                    },
                    scores: {},
                    years: []
                }
            }
        };

        let activeCell = null;

        // --- DOM ELEMENTS ---
        const tableContainer = document.getElementById('table-container');
        const scoresTable = document.getElementById('scores-table');
        const tableHead = document.getElementById('table-head');
        const tableBody = document.getElementById('table-body');
        const tableFoot = document.getElementById('table-foot');
        const modalContainer = document.getElementById('modal-container'); // Subject modal (now combined)
        const closeModalBtn = document.getElementById('close-modal-btn'); // Subject modal close
        const modalContentSubjects = document.getElementById('modal-content-subjects'); // Subject modal content
        const bottomActions = document.getElementById('bottom-actions');
        const activeCellInfo = document.getElementById('active-cell-info');
        const gotoQpBtn = document.getElementById('goto-qp-btn');
        const gotoMsBtn = document.getElementById('goto-ms-btn');
        const paperGraphsContainer = document.getElementById('paper-graphs'); // Container for per-paper graphs
        
        // Combined message and button container for no papers state
        const noPapersStateContainer = document.getElementById('no-papers-state'); 
        const selectPapersIntroBtn = document.getElementById('select-papers-intro-btn'); // New button for intro screen

        // Year Range Selectors (now within main modal)
        const startYearSelect = document.getElementById('start-year');
        const startSeriesSelect = document.getElementById('start-series');
        const endYearSelect = document.getElementById('end-year');
        const endSeriesSelect = document.getElementById('end-series');
        const yearRangeError = document.getElementById('year-range-error');

        // New DOM element for the close button on the bottom actions pane
        const closeBottomActionsBtn = document.getElementById('close-bottom-actions-btn');
        const headerDateElement = document.getElementById('header-date'); // Get the header date element

        // Exam level select dropdown
        const examLevelSelect = document.getElementById('exam-level-select');


        // --- LOCAL STORAGE FUNCTIONS ---
        function loadStateFromStorage() {
            try {
                const saved = localStorage.getItem(appId);
                if (saved) {
                    const data = JSON.parse(saved);
                    // Load currentMode
                    appState.currentMode = data.currentMode || 'IAL';

                    // Initialize modes structure if not present
                    appState.modes.IAL = data.modes?.IAL || {};
                    appState.modes.IGCSE = data.modes?.IGCSE || {};

                    // Ensure nested properties exist for each mode
                    ['IAL', 'IGCSE'].forEach(mode => {
                        appState.modes[mode].selectedPapers = appState.modes[mode].selectedPapers || {};
                        // Ensure all subject entries in selectedPapers are arrays
                        for (const subject in appState.modes[mode].selectedPapers) {
                            if (!Array.isArray(appState.modes[mode].selectedPapers[subject])) {
                                appState.modes[mode].selectedPapers[subject] = [];
                            }
                        }
                        appState.modes[mode].scores = appState.modes[mode].scores || {};
                        
                        // Validate and set years for each mode
                        if (appState.modes[mode].years && Array.isArray(appState.modes[mode].years) && appState.modes[mode].years.every(y => typeof y === 'object' && y.year && y.series)) {
                             // Years data is valid
                        } else {
                            console.warn(`Invalid 'years' data for ${mode} mode in localStorage, using default range.`);
                            // Default ranges based on mode
                            if (mode === 'IAL') {
                                appState.modes.IAL.years = generateYearSeriesRange(2019, 'Jan', 2025, 'Jun', ialSeriesOrder, ialMaxYearSelect, ialMaxSeriesSelect);
                            } else { // IGCSE
                                appState.modes.IGCSE.years = generateYearSeriesRange(2010, 'Jan', 2025, 'Nov', igcseSeriesOrder, igcseMaxYearSelect, igcseMaxSeriesSelect);
                            }
                        }
                        sortYearSeriesList(appState.modes[mode].years, getCurrentSeriesOrder(mode)); // Sort loaded years for each mode
                    });
                    console.log("State loaded from localStorage:", appState);
                } else {
                    // If no state found, initialize with default year range and selected papers for both modes
                    appState.modes.IAL.years = generateYearSeriesRange(2019, 'Jan', 2025, 'Jun', ialSeriesOrder, ialMaxYearSelect, ialMaxSeriesSelect);
                    appState.modes.IAL.selectedPapers = {
                        'Math': ['P1', 'P2', 'P3', 'P4'],
                        'Physics': ['Unit 1', 'Unit 2']
                    };
                    appState.modes.IGCSE.years = generateYearSeriesRange(2010, 'Jan', 2025, 'Nov', igcseSeriesOrder, igcseMaxYearSelect, igcseMaxSeriesSelect);
                    appState.modes.IGCSE.selectedPapers = {
                        'Math A': ['Paper 1H', 'Paper 2H'], // Updated default to Math A
                        'Chinese': ['Paper 1H']
                    };
                }
            } catch (error) {
                console.error("Error loading state from localStorage:", error);
                // Fallback to default state in case of parsing error
                appState.modes.IAL.years = generateYearSeriesRange(2019, 'Jan', 2025, 'Jun', ialSeriesOrder, ialMaxYearSelect, ialMaxSeriesSelect);
                appState.modes.IGCSE.years = generateYearSeriesRange(2010, 'Jan', 2025, 'Nov', igcseSeriesOrder, igcseMaxYearSelect, igcseMaxSeriesSelect);
            }
        }

        function saveStateToStorage() {
            try {
                localStorage.setItem(appId, JSON.stringify(appState));
                console.log("State saved to localStorage");
                console.log(appState);
            } catch (error) {
                console.error("Error saving state to localStorage:", error);
            }
        }

        // --- HELPER FUNCTIONS FOR CURRENT MODE DATA ---
        function getCurrentSubjectsData() {
            return appState.currentMode === 'IAL' ? ialSubjectsData : igcseSubjectsData;
        }

        function getCurrentPaperMaxMarks() {
            return appState.currentMode === 'IAL' ? ialPaperMaxMarks : igcsePaperMaxMarks;
        }

        function getCurrentSeries(mode = appState.currentMode) {
            return mode === 'IAL' ? ialSeries : igcseSeries;
        }

        function getCurrentSeriesOrder(mode = appState.currentMode) {
            return mode === 'IAL' ? ialSeriesOrder : igcseSeriesOrder;
        }

        function getCurrentMaxYearSelect() {
            return appState.currentMode === 'IAL' ? ialMaxYearSelect : igcseMaxYearSelect;
        }

        function getCurrentMaxSeriesSelect() {
            return appState.currentMode === 'IAL' ? ialMaxSeriesSelect : igcseMaxSeriesSelect;
        }

        // --- RENDERING LOGIC ---
        function renderAll() {
            // Set the dropdown value based on current mode
            examLevelSelect.value = appState.currentMode;

            renderTable();
            populateModal(); // For subject selection
            initYearRangeSelectors(); // For year range selection within the modal
            updateHeaderDate(); // Update the header date
            hideBottomActions(); // Ensure bottom actions are hidden on re-render
        }

        function renderTable() {
            const flatPaperList = getFlatPaperList();
            const currentPaperMaxMarks = getCurrentPaperMaxMarks();
            const currentYears = appState.modes[appState.currentMode].years; // Get years for current mode

            // Clear table content first
            tableHead.innerHTML = '';
            tableBody.innerHTML = '';
            tableFoot.innerHTML = ''; // Clear table footer too

            // If no papers selected, display a message and the intro button, hide the table
            if (flatPaperList.length === 0) {
                noPapersStateContainer.classList.remove('hidden'); // Show the container
                scoresTable.classList.add('hidden'); // Hide the table element
                return;
            } else {
                noPapersStateContainer.classList.add('hidden'); // Hide the container
                scoresTable.classList.remove('hidden'); // Show the table element
            }

            // Render Header Row
            const headerRow = document.createElement('tr');
            const topLeftTh = document.createElement('th');
            // Button inside the table header now, for when papers *are* selected
            topLeftTh.innerHTML = `
                <button id="open-select-papers-modal-btn-in-table" class="btn-primary flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    <span class="ml-0">Select Papers</span>
                </button>
            `;
            headerRow.appendChild(topLeftTh);

            // Add event listener to the newly created button (only exists when table is visible)
            topLeftTh.querySelector('#open-select-papers-modal-btn-in-table').addEventListener('click', () => modalContainer.classList.remove('hidden'));


            flatPaperList.forEach(({ subject, paper }) => {
                const th = document.createElement('th');
                th.innerHTML = `<div>${subject}</div><div class="font-normal text-sm">${paper}</div>`;
                headerRow.appendChild(th);
            });
            tableHead.appendChild(headerRow);

            // Render Table Body Rows
            currentYears.forEach(({ year, series: serie }) => {
                const row = document.createElement('tr');
                const firstTd = document.createElement('td');
                // Display year and compact series name
                firstTd.textContent = `${year} ${serie}`;
                row.appendChild(firstTd);

                flatPaperList.forEach(({ subject, paper }) => {
                    const cell = document.createElement('td');
                    const scoreCell = document.createElement('div');
                    scoreCell.classList.add('score-cell');
                    scoreCell.setAttribute('contenteditable', 'true');

                    // Unique cell ID including mode
                    const cellId = `${appState.currentMode}_${year}_${serie}_${subject}_${paper}`.replace(/\s/g, '_');
                    scoreCell.dataset.id = cellId;
                    scoreCell.dataset.subject = subject;
                    scoreCell.dataset.paper = paper;
                    scoreCell.dataset.year = year;
                    scoreCell.dataset.series = serie;
                    scoreCell.dataset.mode = appState.currentMode; // Store mode in dataset

                    const score = appState.modes[appState.currentMode].scores[cellId] || '';
                    scoreCell.textContent = score; // Only raw score here

                    // Check if this paper should be disabled based on the disabledPapersList
                    const isDisabled = disabledPapersList.some(item =>
                        item.examLevel === appState.currentMode &&
                        item.subject === subject &&
                        item.series === serie &&
                        
                        (item.paper === null || item.paper === paper) &&
                        (item.year === null || item.year === year)
                    );

                    if (isDisabled) {
                        scoreCell.setAttribute('contenteditable', 'false');
                        scoreCell.classList.add('disabled');
                        scoreCell.textContent = 'N/A';
                    } else if (appState.currentMode === 'IAL' && serie === 'Oct' && paper.startsWith('FP')) {
                        // Original IAL FP paper disabling logic
                        scoreCell.setAttribute('contenteditable', 'false');
                        scoreCell.classList.add('disabled');
                        scoreCell.textContent = 'N/A';
                    }

                    updateCellColor(scoreCell, score, paper, currentPaperMaxMarks); // Only color, no text content change

                    cell.appendChild(scoreCell);
                    row.appendChild(cell);
                });
                tableBody.appendChild(row);
            });

            // Render Mean Scores Row in the footer
            const meanRow = document.createElement('tr');
            meanRow.classList.add('mean-score-row'); // Add class for styling

            const meanLabelCell = document.createElement('td');
            meanLabelCell.textContent = 'Mean Score';
            meanRow.appendChild(meanLabelCell);

            flatPaperList.forEach(({ subject, paper }) => {
                const meanScoreCell = document.createElement('td');
                const meanScoreDiv = document.createElement('div');
                meanScoreDiv.classList.add('score-cell'); // Re-use score-cell class for styling

                const mean = calculateMeanScore(subject, paper);
                const meanText = mean !== null ? mean.toFixed(1) : 'N/A'; // Format to 1 decimal place or 'N/A'
                meanScoreDiv.textContent = meanText;

                // Apply coloring to the mean score cell
                updateCellColor(meanScoreDiv, mean, paper, currentPaperMaxMarks);

                meanScoreCell.appendChild(meanScoreDiv);
                meanRow.appendChild(meanScoreCell);
            });
            tableFoot.appendChild(meanRow);
        }

        function populateModal() {
            modalContentSubjects.innerHTML = ''; // Clear previous content
            const currentSubjectsData = getCurrentSubjectsData();
            const currentSelectedPapers = appState.modes[appState.currentMode].selectedPapers;

            Object.entries(currentSubjectsData).forEach(([subject, data]) => {
                const subjectDiv = document.createElement('div');
                subjectDiv.className = 'mb-6';

                const headerDiv = document.createElement('div');
                headerDiv.className = 'flex items-center justify-between mb-3';

                const title = document.createElement('h3');
                title.className = 'text-lg font-bold text-gray-700';
                title.textContent = subject;

                const selectAllLabel = document.createElement('label');
                selectAllLabel.className = 'flex items-center space-x-2 text-sm font-medium text-gray-600 cursor-pointer';
                const selectAllCheckbox = document.createElement('input');
                selectAllCheckbox.type = 'checkbox';
                selectAllCheckbox.className = 'rounded custom-checkbox mr-2';
                selectAllCheckbox.dataset.subject = subject;
                selectAllCheckbox.addEventListener('change', handleSelectAllChange);
                selectAllLabel.appendChild(selectAllCheckbox);
                selectAllLabel.append('Select All');

                headerDiv.appendChild(title);
                headerDiv.appendChild(selectAllLabel);
                subjectDiv.appendChild(headerDiv);

                const papersGrid = document.createElement('div');
                papersGrid.className = 'grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3';

                data.papers.forEach(paper => {
                    const label = document.createElement('label');
                    label.className = 'flex items-center space-x-2 p-2 rounded-md bg-gray-100 hover:bg-gray-200 transition cursor-pointer';
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    // Added paper-checkbox class for easier selection in Select All logic
                    checkbox.className = 'rounded custom-checkbox mr-2 paper-checkbox';
                    checkbox.dataset.subject = subject;
                    // FIX: Ensure the data-paper attribute is set for individual checkboxes
                    checkbox.dataset.paper = paper;
                    // Check if the paper is already selected from appState for the current mode
                    checkbox.checked = currentSelectedPapers[subject]?.includes(paper) || false;
                    checkbox.addEventListener('change', handlePaperSelectionChange);

                    label.appendChild(checkbox);
                    label.append(paper);
                    papersGrid.appendChild(label);
                });

                subjectDiv.appendChild(papersGrid);
                modalContentSubjects.appendChild(subjectDiv);
                // Update the state of the "Select All" checkbox based on individual paper selections
                updateSelectAllCheckboxState(subject);
            });
        }

        function initYearRangeSelectors() {
            // Clear existing options
            startYearSelect.innerHTML = '';
            endYearSelect.innerHTML = '';
            startSeriesSelect.innerHTML = '';
            endSeriesSelect.innerHTML = '';

            const currentSeriesArr = getCurrentSeries();
            const currentMaxYear = getCurrentMaxYearSelect();
            const currentSeriesOrderObj = getCurrentSeriesOrder();

            // Populate series dropdowns
            currentSeriesArr.forEach(s => {
                const optionStart = document.createElement('option');
                optionStart.value = s;
                optionStart.textContent = s;
                startSeriesSelect.appendChild(optionStart);

                const optionEnd = document.createElement('option');
                optionEnd.value = s;
                optionEnd.textContent = s;
                endSeriesSelect.appendChild(optionEnd);
            });

            const currentYear = new Date().getFullYear();
            // Generate years from 2000 up to currentMaxYear or currentYear (whichever is greater, but not exceeding currentMaxYear)
            for (let year = Math.max(currentYear, currentMaxYear); year >= 2000; year--) {
                const optionStart = document.createElement('option');
                optionStart.value = year;
                optionStart.textContent = year;
                startYearSelect.appendChild(optionStart);

                const optionEnd = document.createElement('option');
                optionEnd.value = year;
                optionEnd.textContent = year;
                endYearSelect.appendChild(optionEnd);
            }

            // Set initial selected values in the dropdowns based on current appState.years for the active mode
            const currentYearsList = appState.modes[appState.currentMode].years;
            if (currentYearsList.length > 0) {
                // appState.years is sorted descending, so the first element is the latest, last is earliest.
                const latestYearSeries = currentYearsList[0];
                const earliestYearSeries = currentYearsList[currentYearsList.length - 1];

                startYearSelect.value = earliestYearSeries.year;
                startSeriesSelect.value = earliestYearSeries.series;
                endYearSelect.value = latestYearSeries.year;
                endSeriesSelect.value = latestYearSeries.series;
            } else {
                 // Fallback if appState.years is empty, though it should be initialized by loadStateFromStorage
                // Set reasonable defaults based on current mode if no years are set
                if (appState.currentMode === 'IAL') {
                    startYearSelect.value = 2019;
                    startSeriesSelect.value = 'Jan';
                    endYearSelect.value = 2025;
                    endSeriesSelect.value = 'Jun';
                } else { // IGCSE
                    startYearSelect.value = 2010;
                    startSeriesSelect.value = 'Jan';
                    endSeriesSelect.value = 2025;
                    endSeriesSelect.value = 'Nov';
                }
            }
        }

        // New function to update the header date
        function updateHeaderDate() {
            const today = new Date();
            const options = { month: 'short', day: 'numeric' };
            headerDateElement.textContent = today.toLocaleDateString('en-US', options);
        }

        // --- UTILITY FUNCTIONS ---
        // Generates an array of {year, series} objects within the specified range
        function generateYearSeriesRange(startYear, startSeries, endYear, endSeries, seriesOrderObj, maxYear, maxSeries) {
            const result = [];

            // Ensure years do not go beyond the maxYearSelect/maxSeriesSelect boundary
            const actualEndYear = Math.min(endYear, maxYear);
            let actualEndSeries = endSeries;
            if (endYear === maxYear && seriesOrderObj[endSeries] > seriesOrderObj[maxSeries]) {
                actualEndSeries = maxSeries;
            }

            // Loop backwards from actualEndYear/actualEndSeries to startYear/startSeries
            for (let year = actualEndYear; year >= startYear; year--) {
                const currentYearSeries = [];
                // Sort series array to ensure iteration order is consistent (Jan, Jun, Oct/Nov)
                const sortedSeriesKeys = Object.keys(seriesOrderObj).sort((a,b) => seriesOrderObj[a] - seriesOrderObj[b]);

                for (let i = sortedSeriesKeys.length - 1; i >= 0; i--) {
                    const serie = sortedSeriesKeys[i];
                    // Skip series after the actual end series for the end year
                    if (year === actualEndYear && seriesOrderObj[serie] > seriesOrderObj[actualEndSeries]) {
                        continue;
                    }
                    // Skip series before the start series for the start year
                    if (year === startYear && seriesOrderObj[serie] < seriesOrderObj[startSeries]) {
                        continue;
                    }
                    currentYearSeries.push({ year, series: serie });
                }
                // Add the series for the current year in correct order (Jan, Jun, Oct/Nov)
                currentYearSeries.sort((a,b) => seriesOrderObj[a.series] - seriesOrderObj[b.series]);
                result.push(...currentYearSeries);
            }
            // Sort the generated list in descending order (latest year/series first)
            sortYearSeriesList(result, seriesOrderObj);
            return result;
        }

        function sortYearSeriesList(list, seriesOrderObj) {
            list.sort((a, b) => {
                if (a.year !== b.year) return b.year - a.year; // Descending year
                return seriesOrderObj[b.series] - seriesOrderObj[a.series]; // Descending series within year
            });
        }

        function getFlatPaperList() {
            const list = [];
            const currentSubjectsData = getCurrentSubjectsData();
            const currentSelectedPapers = appState.modes[appState.currentMode].selectedPapers;

            Object.keys(currentSubjectsData).forEach(subject => {
                // Check if the subject exists in currentSelectedPapers and if it's an array with items
                if (currentSelectedPapers[subject] && Array.isArray(currentSelectedPapers[subject])) {
                    // Sort selected papers based on the order in currentSubjectsData
                    const sortedPapers = currentSubjectsData[subject].papers.filter(p => currentSelectedPapers[subject].includes(p));
                    sortedPapers.forEach(paper => {
                        list.push({ subject, paper });
                    });
                }
            });
            return list;
        }

        // Updated: Only color cell, do not modify its text content
        function updateCellColor(cell, score, paper, paperMaxMarks) {
            cell.style.backgroundColor = ''; // Reset background color

            if (score === '' || score === null || isNaN(score)) {
                return;
            }

            const maxMark = paperMaxMarks[paper];
            if (maxMark) {
                const percentage = ((parseFloat(score) / maxMark) * 100).toFixed(0);

                let color = '';
                if (percentage >= 90) color = 'var(--color-90)';
                else if (percentage >= 80) color = 'var(--color-80)';
                else if (percentage >= 60) color = 'var(--color-70)';
                else if (percentage >= 30) color = 'var(--color-50)';
                else color = 'var(--color-fail)';

                cell.style.backgroundColor = `${color}`;
            }
        }

        function updateSelectAllCheckboxState(subject) {
            // Now targets elements with the new 'paper-checkbox' class
            const allCheckboxes = modalContentSubjects.querySelectorAll(`.paper-checkbox[data-subject="${subject}"]`);
            const checkedCheckboxes = modalContentSubjects.querySelectorAll(`.paper-checkbox[data-subject="${subject}"]:checked`);
            const selectAllCheckbox = modalContentSubjects.querySelector(`input[data-subject="${subject}"][type="checkbox"]:not(.paper-checkbox)`);
            if (!selectAllCheckbox) return;

            if (allCheckboxes.length > 0 && allCheckboxes.length === checkedCheckboxes.length) {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false;
            } else if (checkedCheckboxes.length > 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = true;
            } else {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            }
        }

        // Function to calculate a simplified percentile based on a skewed distribution with median at 70%
        function calculatePercentile(scorePercentage) {
            if (isNaN(scorePercentage)) return '0';
            if (scorePercentage < 0) scorePercentage = 0;
            if (scorePercentage > 100) scorePercentage = 100;

            let percentile;
            if (scorePercentage <= 70) {
                // From 0-70% score, map to 0-50th percentile (linear)
                percentile = (scorePercentage / 70) * 50;
            } else {
                // From 70-100% score, map to 50-100th percentile (linear, but stretched)
                percentile = 50 + ((scorePercentage - 70) / 30) * 50; // Changed from 20 to 30 for smoother transition
            }
            return percentile.toFixed(0); // Round to nearest whole number
        }

        // Function to render the small graphs in the overlay
        function renderPaperGraphs(score, maxMark) {
            paperGraphsContainer.innerHTML = ''; // Clear previous graphs

            // Score Reached Progress Bar
            const scoreProgressDiv = document.createElement('div');
            scoreProgressDiv.className = 'overlay-graph';
            let percentage = 0;
            if (score && !isNaN(score) && maxMark && maxMark > 0) {
                percentage = Math.min(100, (parseInt(score, 10) / maxMark) * 100).toFixed(0);
            }
            scoreProgressDiv.innerHTML = `
            <div style="display: flex; flex-direction: column; justify-content: space-between; align-items: left">
              <div class="overlay-graph-title">Grade: A*</div>
                <div class="overlay-graph-title">UMS: <span class="text-center mt-1 text-gray-600">${score || 0} / ${maxMark || 0}</span></div>
                </div>
                <div class="progress-bar-container">
                    <div class="progress-bar" style="width: ${percentage}%;"></div>
                </div>
            `;
            paperGraphsContainer.appendChild(scoreProgressDiv);

            // Skewed Normal Distribution Graph with ApexCharts
            const normalDistDiv = document.createElement('div');
            normalDistDiv.className = 'overlay-graph';
            // Corrected: Added a div with overlay-graph-title inside normalDistDiv
            normalDistDiv.innerHTML = `<div class="overlay-graph-title"></div><div id="chart-skewed-dist"></div>`;
            paperGraphsContainer.appendChild(normalDistDiv);

            // Calculate current score's percentile
            const scorePercentage = (score && !isNaN(score) && maxMark && maxMark > 0) ? (parseFloat(score) / maxMark) * 100 : NaN;
            const currentPercentile = calculatePercentile(scorePercentage);


            // ApexCharts options for the skewed distribution
            // Data manually crafted to create a left-skewed distribution, peaking around 80-90%
            // These are relative frequencies or densities for arbitrary bins (e.g., 0-10%, 10-20%...)
            const chartOptions = {
                chart: {
                    type: "area",
                    height: 40, // Smaller height for overlay
                    toolbar: {
                        show: false // Hide toolbar
                    },
                    sparkline: {
                        enabled: true // Use sparkline mode for minimal chart
                    },
                    animations: {
                        enabled: false // Disable animations for faster rendering in overlay
                    },
                    parentHeightOffset: 0 // Remove vertical offset
                },
                dataLabels: {
                    enabled: false
                },
                stroke: {
                    curve: 'smooth',
                    width: 1,
                    colors: ['var(--primary-color)']
                },
                series: [
                    {
                        name: "Distribution",
                        // Data points for a left-skewed distribution, peaking around 80-90%
                        // These are relative frequencies or densities for arbitrary bins (e.g., 0-10%, 10-20%...)
                        data: [1, 2, 5, 10, 20, 40, 70, 90, 100, 95, 80, 60, 40, 20, 10, 5, 2, 1, 0.5, 0.2] // 20 data points for 5% bins
                    },

                ],
                fill: {
                    type: "gradient",
                    gradient: {
                        shadeIntensity: 1,
                        opacityFrom: 0.7,
                        opacityTo: 0.9,
                        stops: [0, 90, 100],
                        colorStops: [{
                            offset: 0,
                            color: 'var(--primary-color)',
                            opacity: 0.3
                        }, {
                            offset: 100,
                            color: 'var(--primary-color)',
                            opacity: 0.1
                        }]
                    }
                },
                xaxis: {
                    categories: Array.from({length: 20}, (_, i) => `${i*5}%`), // Categories for 5% bins
                    labels: {
                        show: false // Hide x-axis labels
                    },
                    axisBorder: {
                        show: false
                    },
                    axisTicks: {
                        show: false
                    },
                    tooltip: {
                        enabled: false // Hide x-axis tooltip
                    }
                },
                yaxis: {
                    show: false // Hide y-axis
                },
                grid: {
                    show: false, // Hide grid lines
                    padding: {
                        left: -5,
                        right: -5,
                        top: -5,
                        bottom: -5
                    }
                },
                tooltip: {
                    enabled: false // Hide chart tooltip
                }
            };

            const chart = new ApexCharts(normalDistDiv.querySelector("#chart-skewed-dist"), chartOptions); // Target the correct element
            chart.render();

            // Update the title of the skewed distribution graph with the calculated percentile
            normalDistDiv.querySelector('.overlay-graph-title').textContent = `${currentPercentile}th Percentile`;
            // Add a subtitle for the median information
            const medianSubtitle = document.createElement('div');
            medianSubtitle.className = 'text-xs text-gray-500 mt-0';
            // medianSubtitle.textContent = 'Median at 80%'; // This was commented out in original
            normalDistDiv.querySelector('.overlay-graph-title').insertAdjacentElement('afterend', medianSubtitle);
        }

        // NEW: Calculate Mean Score for a given paper based on current mode
        function calculateMeanScore(subject, paper) {
            let totalScore = 0;
            let count = 0;
            const currentScores = appState.modes[appState.currentMode].scores;
            const currentYears = appState.modes[appState.currentMode].years;

            // Iterate through all years and series to find scores for this specific paper
            currentYears.forEach(({ year, series: serie }) => {
                const cellId = `${appState.currentMode}_${year}_${serie}_${subject}_${paper}`.replace(/\s/g, '_');
                const scoreStr = currentScores[cellId];
                const score = parseFloat(scoreStr); // Use parseFloat for scores

                // Only include valid numbers in the mean calculation and not 'N/A'
                if (!isNaN(score) && cellId.indexOf('N/A') === -1) { // Check if not 'N/A'
                    totalScore += score;
                    count++;
                }
            });

            if (count > 0) {
                return totalScore / count;
            } else {
                return null; // No valid scores to calculate a mean
            }
        }


        // --- DRAGGING STATE AND FUNCTIONS ---
        let isDragging = false;
        let dragOffsetX, dragOffsetY; // Offset from mouse click to element's current top-left
        let currentLeft, currentTop; // Element's current position (left, top)

        // Function to set the initial position of the bottom bar (bottom-right with 60px margin)
        function setInitialBottomBarPosition() {
            bottomActions.style.transition = 'none'; // Disable transition for initial positioning

            const rect = bottomActions.getBoundingClientRect();
            // Calculate position to be 60px from right and 60px from bottom
            currentLeft = window.innerWidth - rect.width - 60;
            currentTop = window.innerHeight - rect.height - 60;

            bottomActions.style.left = `${currentLeft}px`;
            bottomActions.style.top = `${currentTop}px`;

            // Re-enable transition after positioning
            setTimeout(() => {
                bottomActions.style.transition = '';
            }, 50); // Small delay to allow style application
        }

        // --- DRAGGING EVENT HANDLERS ---
        function startDrag(e) {
            // Do not start drag if the event target is an interactive element within the pane
            if (e.target.closest('button') || e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.getAttribute('contenteditable') === 'true') {
                return;
            }

            isDragging = true;
            bottomActions.classList.add('cursor-grabbing');
            bottomActions.classList.remove('cursor-grab');

            // Get the current computed position
            const rect = bottomActions.getBoundingClientRect();
            currentLeft = rect.left;
            currentTop = rect.top;

            // Calculate the offset from the mouse click to the top-left of the element
            dragOffsetX = e.clientX - currentLeft;
            dragOffsetY = e.clientY - currentTop;

            e.preventDefault(); // Prevent default browser drag behavior (e.g., text selection)
        }

        function drag(e) {
            if (!isDragging) return;

            e.preventDefault(); // Prevent default browser drag behavior

            let newX = e.clientX - dragOffsetX;
            let newY = e.clientY - dragOffsetY;

            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            const rect = bottomActions.getBoundingClientRect();
            const elementWidth = rect.width;
            const elementHeight = rect.height;

            // Clamp newX and newY to stay within viewport bounds
            newX = Math.max(0, Math.min(viewportWidth - elementWidth, newX));
            newY = Math.max(0, Math.min(viewportHeight - elementHeight, newY));

            bottomActions.style.left = `${newX}px`;
            bottomActions.style.top = `${newY}px`;
        }

        function endDrag() {
            isDragging = false;
            bottomActions.classList.remove('cursor-grabbing');
            bottomActions.classList.add('cursor-grab');
        }

        function hideBottomActions() {
            bottomActions.classList.add('translate-y-20', 'opacity-0', 'invisible');
            activeCell = null;
        }

        // --- EVENT HANDLERS (for content) ---
        function handleScoreInput(e) {
            const cell = e.target;
            // Check if contenteditable is false (e.g., for 'N/A' cells)
            if (!cell.classList.contains('score-cell') || cell.getAttribute('contenteditable') === 'false') return;

            const { id, paper, subject } = cell.dataset; // Get subject here too
            const score = cell.textContent.trim(); // Get the raw input

            appState.modes[appState.currentMode].scores[id] = score; // Store score in current mode's state
            updateCellColor(cell, score, paper, getCurrentPaperMaxMarks()); // Only update color, text remains raw input

            // Debounce saving to localStorage
            clearTimeout(window.saveTimeout);
            window.saveTimeout = setTimeout(saveStateToStorage, 500);

            // Also update the bottom action bar info and graphs
            updateBottomActions(cell);

            // Update the mean score for the specific paper when a score changes
            updateMeanScoreInTable(subject, paper);
        }

        // New function to update only the relevant mean score cell
        function updateMeanScoreInTable(subject, paper) {
            const flatPaperList = getFlatPaperList();
            const paperIndex = flatPaperList.findIndex(p => p.subject === subject && p.paper === paper);

            if (paperIndex !== -1) {
                // The first cell in the mean row is the "Mean Score" label, so add 1 to index
                const meanCellElement = tableFoot.querySelector(`.mean-score-row td:nth-child(${paperIndex + 2}) .score-cell`);
                if (meanCellElement) {
                    const mean = calculateMeanScore(subject, paper);
                    const meanText = mean !== null ? mean.toFixed(1) : 'N/A';
                    meanCellElement.textContent = meanText;
                    updateCellColor(meanCellElement, mean, paper, getCurrentPaperMaxMarks());
                }
            }
        }


        // Modified handleCellFocus to only show the bar, not hide it on focusout
        function handleCellFocus(e) {
            const cell = e.target;
            if (!cell.classList.contains('score-cell') || cell.getAttribute('contenteditable') === 'false') {
                return;
            }
            activeCell = cell;
            // If the pane is currently hidden, set its initial position before showing it.
            // This ensures it appears at the default bottom-right if it hasn't been dragged yet.
            if (bottomActions.classList.contains('opacity-0') || bottomActions.style.left === '' || bottomActions.style.top === '') {
                setInitialBottomBarPosition();
            }
            // Remove the classes to make it visible
            bottomActions.classList.remove('translate-y-20', 'opacity-0', 'invisible');
            updateBottomActions(activeCell);
        }

        function updateBottomActions(cell) {
            if (!cell) {
                activeCellInfo.innerHTML = '';
                paperGraphsContainer.innerHTML = ''; // Clear graphs if no cell is active
                return;
            }
            const { subject, paper, year, series, mode } = cell.dataset; // Get mode from dataset
            let examLevelPrefix = mode === 'IAL' ? 'IAL' : 'IGCSE';
            let rawScore = cell.textContent.trim();
            const maxMark = getCurrentPaperMaxMarks()[paper]; // Use current mode's max marks
            let percentageInfo = '';

            if (rawScore && !isNaN(rawScore) && maxMark) {
                const percentage = ((parseInt(rawScore, 10) / maxMark) * 100).toFixed(0);
                percentageInfo = ` (${percentage}%)`;
            } else if (rawScore === 'N/A') {
                percentageInfo = ' (N/A)'; // Add N/A to the percentage display
                rawScore = 'N/A'; // Ensure rawScore is N/A for display purposes if cell says N/A
            }


            activeCellInfo.innerHTML = `<span>${subject} ${paper}</span><br><br><span style="font-size: 30px;">${series} ${year}</span><span style="font-size: 20px; font-weight: 100; color: grey">${percentageInfo}</span>`;

            // Render graphs for the active cell
            renderPaperGraphs(rawScore, maxMark);
        }

        function getFullMonthName(seriesAbbr) {
            const months = { 'Jan': 'January', 'Jun': 'June', 'Oct': 'October', 'Nov': 'November' };
            return months[seriesAbbr] || seriesAbbr; // Return full name or original if not found
        }

        // Reverted handleGoToPaper function to open paper_viewer.html
        function handleGoToPaper(type) {
            if (!activeCell) return;
            const { subject, paper, year, series, mode: examLevel } = activeCell.dataset;
            const examBoard = "Edexcel"; // Assuming Edexcel as the exam board based on the app's context

            const params = new URLSearchParams({
                subject: subject,
                paper: paper,
                series: series,
                year: year,
                examBoard: examBoard,
                examLevel: examLevel
            }).toString();

            // Open in a new window with paper_viewer.html
            window.open(`paper_viewer.html?${params}&type=${type}`, '_blank');
        }

        function handlePaperSelectionChange(e) {
            const { subject, paper } = e.target.dataset;
            const currentSelectedPapers = appState.modes[appState.currentMode].selectedPapers;

            // Ensure currentSelectedPapers[subject] is an array
            if (!currentSelectedPapers[subject]) {
                currentSelectedPapers[subject] = [];
            }

            if (e.target.checked) {
                if (!currentSelectedPapers[subject].includes(paper)) {
                    currentSelectedPapers[subject].push(paper);
                }
            } else {
                // If deselected, filter out the paper
                currentSelectedPapers[subject] = currentSelectedPapers[subject].filter(p => p !== paper);
            }
            updateSelectAllCheckboxState(subject);
            saveStateToStorage(); // Save immediately on selection change
        }

        function handleSelectAllChange(e) {
            const subject = e.target.dataset.subject;
            const papers = getCurrentSubjectsData()[subject].papers;
            // Targets elements with the 'paper-checkbox' class
            const paperCheckboxes = modalContentSubjects.querySelectorAll(`.paper-checkbox[data-subject="${subject}"]`);
            const currentSelectedPapers = appState.modes[appState.currentMode].selectedPapers;

            if (e.target.checked) {
                // Set selected papers to all papers for the subject
                currentSelectedPapers[subject] = [...papers];
                paperCheckboxes.forEach(cb => cb.checked = true);
            } else {
                // Set selected papers for the subject to an empty array
                currentSelectedPapers[subject] = [];
                paperCheckboxes.forEach(cb => cb.checked = false);
            }
            // Update the "Select All" checkbox state after individual paper changes
            updateSelectAllCheckboxState(subject);
            saveStateToStorage();
        }

        // Renamed and modified to handle year range setting when "Done" is clicked on the main modal
        function handleSetYearRangeAndCloseModal() {
            const startYear = parseInt(startYearSelect.value);
            const startSeries = startSeriesSelect.value;
            const endYear = parseInt(endYearSelect.value);
            const endSeries = endSeriesSelect.value;

            // Date validation: start date must be before or equal to end date
            const currentSeriesOrderObj = getCurrentSeriesOrder();
            const startDateWeight = startYear * 100 + currentSeriesOrderObj[startSeries];
            const endDateWeight = endYear * 100 + currentSeriesOrderObj[endSeries];

            if (startDateWeight > endDateWeight) {
                yearRangeError.classList.remove('hidden');
                return; // Prevent closing modal if validation fails
            } else {
                yearRangeError.classList.add('hidden');
            }

            // Generate the new year/series list for the current mode
            const newYears = generateYearSeriesRange(startYear, startSeries, endYear, endSeries,
                                                     currentSeriesOrderObj, getCurrentMaxYearSelect(), getCurrentMaxSeriesSelect());
            appState.modes[appState.currentMode].years = newYears;

            saveStateToStorage();
            renderTable(); // Re-render table completely when year range changes
            modalContainer.classList.add('hidden'); // Close the main modal
        }

        // Function to switch modes
        function switchMode(newMode) {
            if (appState.currentMode === newMode) return; // No change needed

            appState.currentMode = newMode;
            saveStateToStorage(); // Save the new current mode
            renderAll(); // Re-render everything for the new mode
        }

        // --- EVENT LISTENERS ---
        closeModalBtn.addEventListener('click', handleSetYearRangeAndCloseModal); // Now handles both closing and year range

        // Close main modal if clicking outside
        modalContainer.addEventListener('click', (e) => {
            if (e.target === modalContainer) {
                // Perform year range validation before closing if clicking outside
                handleSetYearRangeAndCloseModal();
            }
        });

        tableContainer.addEventListener('input', handleScoreInput);
        tableContainer.addEventListener('focusin', handleCellFocus);

        // Event listeners for the action buttons in the overlay
        gotoQpBtn.addEventListener('click', () => handleGoToPaper('qp'));
        gotoMsBtn.addEventListener('click', () => handleGoToPaper('ms'));

        // Draggable functionality for bottomActions
        bottomActions.addEventListener('mousedown', startDrag);
        document.addEventListener('mousemove', drag);
        document.addEventListener('mouseup', endDrag);

        // Close button for bottomActions
        closeBottomActionsBtn.addEventListener('click', hideBottomActions);

        // Exam level select dropdown listener
        examLevelSelect.addEventListener('change', (e) => switchMode(e.target.value));

        // New event listener for the intro select papers button
        selectPapersIntroBtn.addEventListener('click', () => modalContainer.classList.remove('hidden'));


        // --- STARTUP ---
        loadStateFromStorage();
        renderAll(); // Renders table and initializes both modals (subjects and year range)

        // Set the initial position of the draggable bottom bar on page load
        window.addEventListener('load', setInitialBottomBarPosition);

        // Hide the bottom actions pane initially
        bottomActions.classList.add('opacity-0', 'translate-y-20','invisible');
    </script>
</body>
</html>
