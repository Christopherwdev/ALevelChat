<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Teach</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.17/marked.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#FF3B30',
                        biology: '#0FBD8C',
                        chemistry: '#FF8585',
                        physics: '#4081FF',
                        math: '#FFAB1A',
                    },
                },
            },
        };
    </script>
    <style>
        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        body {
            font-family: 'Inter', sans-serif;
            color: #333;
            overflow: hidden;
        }

        em {
            font-style: normal;
            background-color: #ffff0064;

        }

        .chat-container {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            padding-bottom: 80px;
            font-size: 14px;
        }

        .message-wrapper {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            max-width: 90%;
        }

        .message {
            padding: 0.75rem 1rem;
            border-radius: 1.25rem;
            word-wrap: break-word;
            animation: fadeIn 0.3s ease-out;
            flex-shrink: 1;
        }

        .ai-message {
            align-self: flex-start;
            color: #1a202c;
            padding: 0px;
            border-bottom-left-radius: 0.25rem;
        }

        .ai-newchapter-message {
            margin: 10px 0px 10px 0px;
            align-self: flex-start;
            background-color: white;
            color: #000000;
            border-radius: 1.25rem;
            font-size: 25px;
            border: 5px solid #007aff;
            line-height: 1.5em;
            font-weight: 900;
            max-width: 100%;
            padding: 15px;
        }


        .ai-newsection-message {
            margin: 10px 0px 10px 0px;
            align-self: flex-start;
        
            color: #000000;
            border-radius: 1.25rem;
            font-size: 25px;
           
            line-height: 1.5em;
            font-weight: 900;
            max-width: 100%;
            padding: 0px;
        }

        .user-message {
            align-self: flex-end;
            background-color: #007bff;
            color: white;
            border-bottom-right-radius: 0.25rem;
        }

        .ai-avatar {
            width: 32px;
            height: 32px;
            border-radius: 9999px;
            object-fit: cover;
            flex-shrink: 0;
        }


        .input-area {
            display: flex;
            align-items: center;
            padding: 1rem;
            border-top: 1px solid #e2e8f0;
            background-color: white;
        }

        .chat-input {
            flex-grow: 1;
            border: 1px solid #cbd5e0;
            border-radius: 9999px;
            padding: 0.75rem 1.25rem;
            outline: none;
            transition: border-color 0.2s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        }

        .chat-input:focus {
            border-color: #3182ce;
        }

        .send-button {
            background-color: #007bff;
            color: white;
            border-radius: 9999px;
            padding: 0.75rem;
            width: 50px;
            margin-left: 0.5rem;
            transition: background-color 0.2s ease;
        }

        .send-button:hover:not(:disabled) {
            background-color: #0056b3;
        }

        .send-button:disabled {
            background-color: #a0aec0;
            cursor: not-allowed;
        }

        .status-message {
            text-align: center;
            font-size: 0.875rem;
            padding: 0.5rem;
            color: #4a5568;
            display: none;
        }

        .error-message {
            color: #e53e3e;
        }

        .action-buttons {
            position: absolute;
            bottom: 80px;
            left: 40%;
            transform: translateX(-50%);
            display: flex;
            justify-content: center;
            gap: 10px;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.95);
            border-radius: 9999px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            z-index: 10;
            width: fit-content;
        }

        .action-button {
            height: 30px;
            padding: 0 15px;
            border-radius: 9999px;
            font-weight: 600;
            transition: background-color 0.2s ease, transform 0.1s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            cursor: pointer;
        }

        .action-button:hover:not(:disabled) {
            opacity: 0.9;
        }

        .action-button:disabled {
            background-color: #a0aec0;
            cursor: not-allowed;
            opacity: 0.7;
            border-color: #00000000;
            color: white;
        }

        .action-button:active {
            transform: scale(0.98);
        }

        .explain-button {
            background-color: white;
            border: 2px solid #007aff;
            color: #007aff;
        }

        .quiz-button {
            background-color: white;
            border: 2px solid #007aff;
            color: #007aff;
        }

        .next-button {
            background-color: #007aff;
            color: white;
        }

        .ending-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            padding: 2rem;
            background-color: #f8f9fa;
        }
        .message h2 {
            font-weight: bold;
            margin: 20px 0px;
            font-size: 20px;
        }
  .message p {
           
            margin-bottom: 10px;
                        margin-top: 10px;
        }
          .message h3 {
            font-weight: bold;
            margin: 20px 0px;
        
        }


        .ending-screen h2 {
            font-size: 2rem;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 1rem;
        }

        .ending-screen p {
            font-size: 1.125rem;
            color: #4a5568;
            margin-bottom: 2rem;
        }

        .ending-screen-buttons {
            display: flex;
            gap: 1rem;
        }

        .syllabus-selection {
            width: 250px;
            flex-shrink: 0;
            background-color: #fff;
            border-right: 1px solid #e2e8f0;
            overflow-y: auto;
        }

        .syllabus-selection h3 {
            font-weight: 600;
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .syllabus-selection ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .syllabus-selection li {
            padding: 0.75rem 1rem;
            cursor: pointer;
            border-bottom: 1px solid #edf2f7;
        }

        .syllabus-selection li:hover {
            background-color: #f7fafc;
        }

        .syllabus-selection li.active {
            background-color: #e2e8f0;
            font-weight: 500;
        }

        /* Chapter progress bar styling */
        .chapter-progress-container {
            width: 100%;
            background-color: #e0e0e0;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 10px;
        }

        .chapter-progress-bar {
            height: 10px;
            background-color: #007aff;
            width: 0%;
            border-radius: 5px;
            transition: width 0.3s ease-in-out;
        }


        /* Responsive adjustments for smaller screens */
        @media (max-width: 768px) {
            .syllabus-selection {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #e2e8f0;
                max-height: 200px;
            }

            .main-content {
                flex-direction: column;
            }
        }

        /* Typing indicator CSS */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.75rem 1rem;
            background-color: #e2e8f0;
            border-radius: 1.25rem;
            max-width: 100px;
            margin-top: 0.5rem;
            animation: fadeIn 0.3s ease-out;
            align-self: flex-start;
            color: #1a202c;
            margin-left: 32px;
        }

        .typing-indicator .avatar-placeholder {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: #ccc;
            flex-shrink: 0;
            margin-right: 0.75rem;
        }

        .typing-indicator .dot {
            width: 8px;
            height: 8px;
            background-color: #888;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .typing-indicator .dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-indicator .dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes bounce {
            0%,
            80%,
            100% {
                transform: scale(0);
            }

            40% {
                transform: scale(1);
            }
        }

        /* Tone Selection Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        .modal-content h3 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
        }

        .tone-option {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
            padding: 0.75rem 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }

        .tone-option:hover {
            background-color: #f7fafc;
            border-color: #a0aec0;
        }

        .tone-option input[type="radio"] {
            margin-right: 10px;
            accent-color: #007bff;
        }

        .tone-option.selected {
            background-color: #e0f2fe;
            border-color: #007bff;
            font-weight: 500;
        }

        .close-button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 1.5rem;
            transition: background-color 0.2s ease;
        }

        .close-button:hover {
            background-color: #0056b3;
        }
    </style>
</head>

<body class="flex flex-col h-screen">
    <!-- Header -->
    <header class="flex justify-between items-center p-4 bg-white border-b dark:bg-gray-800 dark:border-gray-700 h-[80px]">
        <div>
            <h1 class="text-2xl font-bold text-gray-800 dark:text-gray-200">AI Teach</h1>
            <p class="text-xs text-gray-500 mt-1">Your personal AI tutor</p>
        </div>
        <div class="flex items-center space-x-2">
            <!-- Settings / Tone Button -->
            <button id="open-tone-modal-btn" class="text-gray-600 hover:text-gray-800 dark:text-gray-400 dark:hover:text-gray-200 transition-colors">
                <i class="fas fa-cog text-xl"></i>
            </button>
        </div>
    </header>

    <!-- Main Content Area -->
    <div class="flex flex-1 overflow-hidden">
        <!-- Left Pane: Subject, Unit, and Chapter Selection -->
        <div class="syllabus-selection flex flex-col items-center p-4 dark:bg-gray-800 dark:border-gray-700">
            <h3 class="w-full text-center text-xl mb-4 text-gray-800 dark:text-gray-200">Subjects</h3>
            <ul id="subject-list" class="w-full mb-4">
                <!-- Subject buttons will be dynamically added here -->
            </ul>

            <select id="unit-select"
                class="p-2 w-full mt-6 mx-0 border border-gray-300 rounded-md bg-gray-100 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200">
                <!-- Unit options will be dynamically added here -->
            </select>

            <!-- Chapter Selection Section -->
            <div id="chapter-selection-section" class="w-full mt-4 p-2 border border-gray-300 rounded-md bg-gray-100 dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200 hidden">
                <h4 class="font-semibold text-gray-800 dark:text-gray-200 mb-2">Chapter</h4>
                <select id="chapter-select"
                    class="p-2 w-full border border-gray-300 rounded-md bg-white dark:bg-gray-800 dark:border-gray-600 dark:text-gray-200">
                    <!-- Chapter options will be dynamically added here -->
                </select>
                <div class="chapter-progress-container mt-2">
                    <div id="section-progress-bar" class="chapter-progress-bar"></div>
                </div>
                <div class="flex justify-between mt-2">
                    <button id="prev-chapter-btn" class="action-button explain-button w-1/2 mr-1">Previous</button>
                    <button id="next-chapter-btn" class="action-button next-button w-1/2 ml-1">Next</button>
                </div>
            </div>
        </div>

        <!-- Right Pane: Chatbot Interface -->
        <div class="flex-1 flex flex-col relative">
            <div class="chat-container flex-1 bg-white dark:bg-gray-800 px-[100px]" id="chat-container">
                <!-- Chat messages will be appended here -->
                <div id="ai-typing-indicator" class="typing-indicator hidden">
                    <div class="ai-avatar"></div>
                    <div class="dot"></div>
                    <div class="dot"></div>
                    <div class="dot"></div>
                </div>
            </div>

            <!-- Chat Action Buttons -->
            <div class="action-buttons hidden" id="action-buttons-container">
                <button class="action-button explain-button" id="explain-btn">Explain</button>
                <button class="action-button quiz-button" id="quiz-btn">Quiz</button>
                <button class="action-button next-button" id="next-section-btn">Next Section</button>
            </div>

            <!-- Chat Input Area -->
            <div class="input-area">
                <input type="text" id="chat-input" class="chat-input" placeholder="Type your message..." />
                <button class="send-button" id="send-button">
                    <i class="fas fa-paper-plane"></i>
                </button>
                <button class="send-button bg-gray-500 hover:bg-gray-600 ml-2" id="voice-input-btn">
                    <i class="fas fa-microphone"></i>
                </button>
                <button class="send-button bg-red-500 hover:bg-red-600 ml-2" id="clear-chat-btn">
                    <i class="fas fa-trash-alt"></i>
                </button>
            </div>
            <div id="status-message" class="status-message"></div>
        </div>
    </div>

    <!-- Ending Screen Overlay -->
    <div id="ending-screen" class="fixed inset-0 ending-screen hidden">
        <h2>Unit Completed! 🎉</h2>
        <p>You've successfully completed all chapters and sections in this unit. Great job!</p>
        <div class="ending-screen-buttons">
            <button id="restart-unit-btn" class="btn-primary">Restart Unit</button>
            <button id="next-unit-btn" class="btn-primary ml-4">Next Unit</button>
        </div>
    </div>

    <!-- Tone Selection Modal Overlay -->
    <div id="tone-modal-overlay" class="modal-overlay hidden">
        <div class="modal-content">
            <h3>Choose Chatbot Tone</h3>
            <div class="tone-options">
                <label class="tone-option" data-tone="Friendly">
                    Friendly
                    <input type="radio" name="chatbot-tone" value="Friendly" checked>
                </label>
                <label class="tone-option" data-tone="Formal">
                    Formal
                    <input type="radio" name="chatbot-tone" value="Formal">
                </label>
                <label class="tone-option" data-tone="Humorous">
                    Humorous
                    <input type="radio" name="chatbot-tone" value="Humorous">
                </label>
                <label class="tone-option" data-tone="Concise">
                    Concise
                    <input type="radio" name="chatbot-tone" value="Concise">
                </label>
            </div>
            <button id="close-tone-modal-btn" class="close-button">Close</button>
        </div>
    </div>

    <script src="edexcel-ial/chemistry/Unit1.js"></script>
    <script src="edexcel-ial/chemistry/Unit2.js"></script>
    <script src="edexcel-ial/chemistry/Unit3.js"></script>
    <script src="edexcel-ial/chemistry/Unit4.js"></script>
    <script src="edexcel-ial/chemistry/Unit5.js"></script>
    <script src="edexcel-ial/chemistry/Unit6.js"></script>

    <script>
        const syllabus = {
            "Chemistry": {
                units: {
                    1: {
                        title: "Structure, Bonding and Introduction to Organic Chemistry",
                        content: CHEMISTRY_UNIT_1_CONTENT
                    },
                    2: {
                        title: "Energetics, Group Chemistry, Halogenoalkanes and Alcohols",
                        content: CHEMISTRY_UNIT_2_CONTENT
                    },
                    3: {
                        title: "Practical Skills in Chemistry I",
                        content: CHEMISTRY_UNIT_3_CONTENT
                    },
                    4: {
                        title: "Rates, Equilibria and Further Organic Chemistry",
                        content: CHEMISTRY_UNIT_4_CONTENT
                    },
                    5: {
                        title: "Transition Metals and Organic Nitrogen Chemistry",
                        content: CHEMISTRY_UNIT_5_CONTENT
                    },
                    6: {
                        title: "Practical Skills in Chemistry II",
                        content: CHEMISTRY_UNIT_6_CONTENT
                    }
                    // Add other Chemistry units here (up to 6), e.g., 3: { title: "...", content: CHEMISTRY_UNIT_3_CONTENT }
                }
            },
            // "Biology": {
            //     units: {
            //         1: {
            //             title: "Biological Molecules",
            //             content: BIOLOGY_UNIT_1_CONTENT
            //         }
            //         // Add other Biology units here (up to 6)
            //     }
            // },
            // "Physics": {
            //     units: {
            //         1: {
            //             title: "Mechanics and Materials",
            //             content: PHYSICS_UNIT_1_CONTENT
            //         }
            //         // Add other Physics units here (up to 6)
            //     }
            // }
        };

        // --- GLOBAL STATE VARIABLES ---
        let currentChatId = null;
        let recognition = null; // SpeechRecognition object
        let isRecognizing = false; // Flag to track speech recognition state

        let currentSubject = 'Chemistry'; // Default subject
        let currentUnitIndex = 1; // Default unit number
        let currentChapterIndex = 0; // Index in the chapters array for the current unit
        let currentSectionIndex = 0; // Index in the sections array for the current chapter
        let lessonInProgress = false; // Flag to indicate if a lesson has started

        let chatHistoryData = []; // Global variable to store raw chat history (text and sender type)
        let selectedTone = 'Friendly'; // Default tone

        // Local storage key for AI Teach
        const aiTeachLocalStorageKey = 'aiTeachProgress';

        // --- DOM ELEMENTS ---
        const subjectList = document.getElementById('subject-list');
        const unitSelect = document.getElementById('unit-select');
        const chapterSelectionSection = document.getElementById('chapter-selection-section');
        const chapterSelect = document.getElementById('chapter-select');
        const sectionProgressBar = document.getElementById('section-progress-bar'); // Renamed
        const prevChapterBtn = document.getElementById('prev-chapter-btn');
        const nextChapterBtn = document.getElementById('next-chapter-btn');
        const chatContainer = document.getElementById('chat-container');
        const chatInput = document.getElementById('chat-input'); // Retain original ID
        const sendButton = document.getElementById('send-button');
        const voiceInputBtn = document.getElementById('voice-input-btn');
        const clearChatBtn = document.getElementById('clear-chat-btn'); // New button
        const statusMessageDiv = document.getElementById('status-message'); // Retain original ID
        const explainBtn = document.getElementById('explain-btn');
        const quizBtn = document.getElementById('quiz-btn');
        const nextSectionBtn = document.getElementById('next-section-btn'); // Renamed
        const endingScreen = document.getElementById('ending-screen');
        const restartUnitBtn = document.getElementById('restart-unit-btn');
        const nextUnitBtn = document.getElementById('next-unit-btn');
        const aiTypingIndicator = document.getElementById('ai-typing-indicator');
        const actionButtonsContainer = document.getElementById('action-buttons-container');

        // Tone modal elements
        const openToneModalBtn = document.getElementById('open-tone-modal-btn');
        const toneModalOverlay = document.getElementById('tone-modal-overlay');
        const closeToneModalBtn = document.getElementById('close-tone-modal-btn');
        const toneOptions = document.querySelector('.tone-options');


        // --- CONTENT PARSING FUNCTIONS ---

        /**
         * Parses a Markdown string into a structured syllabus object.
         * Assumes:
         * # Unit Title (ignored here, handled by unit object)
         * ## Chapter Title
         * ### Section Title
         * Paragraphs are separated by double newlines.
         * @param {string} markdownContent The raw markdown string for a unit.
         * @returns {object} A structured object containing chapters, sections, and paragraphs.
         */
        function parseMarkdownToSyllabus(markdownContent) {
            const lines = markdownContent.split('\n');
            const chapters = [];
            let currentChapter = null;
            let currentSection = null;
            let sectionContentBuffer = []; // Buffer to collect lines for a section before splitting into paragraphs

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();

                if (line.startsWith('## ')) {
                    // New Chapter
                    if (currentSection) {
                        currentSection.paragraphs = sectionContentBuffer.join('\n').split(/\n\s*\n/).filter(p => p.trim() !== '');
                        sectionContentBuffer = []; // Reset buffer
                    }
                    currentSection = null; // Reset current section

                    // Extract chapter title and remove any leading numbering (e.g., "6. Energetics")
                    const chapterTitle = line.substring(3).trim().replace(/^\d+\.\s*/, '');
                    currentChapter = {
                        title: chapterTitle,
                        sections: []
                    };
                    chapters.push(currentChapter);
                } else if (line.startsWith('### ')) {
                    // New Section
                    if (!currentChapter) {
                        // Handle case where a section appears before any chapter (shouldn't happen with proper formatting)
                        console.warn("Section found before any chapter. Creating a dummy chapter.");
                        currentChapter = {
                            title: "Introduction",
                            sections: []
                        };
                        chapters.push(currentChapter);
                    }
                    if (currentSection) {
                        currentSection.paragraphs = sectionContentBuffer.join('\n').split(/\n\s*\n/).filter(p => p.trim() !== '');
                        sectionContentBuffer = []; // Reset buffer
                    }
                    currentSection = {
                        title: line.substring(4).trim(),
                        paragraphs: []
                    };
                    currentChapter.sections.push(currentSection);
                } else if (currentSection) {
                    // Add content to the current section's buffer
                    sectionContentBuffer.push(line);
                }
            }

            // After the loop, add any remaining content in the buffer to the last section
            if (currentSection) {
                currentSection.paragraphs = sectionContentBuffer.join('\n').split(/\n\s*\n/).filter(p => p.trim() !== '');
            }
            return chapters;
        }

        // Pre-parse the initial syllabus content
        Object.keys(syllabus).forEach(subjectName => {
            Object.keys(syllabus[subjectName].units).forEach(unitNum => {
                const unit = syllabus[subjectName].units[unitNum];
                if (unit.content) {
                    unit.chapters = parseMarkdownToSyllabus(unit.content);
                    delete unit.content; // Remove raw content after parsing
                }
            });
        });

        // --- LOCAL STORAGE FUNCTIONS ---
        function saveProgress() {
            const progress = {
                currentSubject,
                currentUnitIndex,
                currentChapterIndex,
                currentSectionIndex,
                lessonInProgress,
                chatHistory: chatHistoryData,
                selectedTone
            };
            localStorage.setItem(aiTeachLocalStorageKey, JSON.stringify(progress));
            console.log('AI Teach progress saved:', progress);
        }

        function loadProgress() {
            const savedProgress = localStorage.getItem(aiTeachLocalStorageKey);
            if (savedProgress) {
                const progress = JSON.parse(savedProgress);
                currentSubject = progress.currentSubject || 'Chemistry';
                currentUnitIndex = progress.currentUnitIndex || 1;
                currentChapterIndex = progress.currentChapterIndex || 0;
                currentSectionIndex = progress.currentSectionIndex || 0;
                lessonInProgress = progress.lessonInProgress || false;
                chatHistoryData = progress.chatHistory || [];
                selectedTone = progress.selectedTone || 'Friendly';

                // Restore selected tone in the UI
                const radioBtn = document.querySelector(`input[name="chatbot-tone"][value="${selectedTone}"]`);
                if (radioBtn) {
                    radioBtn.checked = true;
                    // Also update the UI styling for the selected tone
                    document.querySelectorAll('.tone-option').forEach(opt => {
                        opt.classList.remove('selected');
                        if (opt.dataset.tone === selectedTone) {
                            opt.classList.add('selected');
                        }
                    });
                }

                chatContainer.innerHTML = '';

                if (chatHistoryData.length === 0) {
                    appendMessage('Hello! Welcome to AI Teach. Please select a subject and unit to start learning!', 'ai');
                } else {
                    chatHistoryData.forEach(msg => {
                        appendMessage(msg.text, msg.sender, true);
                    });
                }
                console.log('AI Teach progress loaded:', progress);
                return true;
            }
            return false;
        }

        // --- CHAT API INTEGRATION ---
        async function startNewChat() {
            try {
                const response = await fetch('https://server-ef04.onrender.com/api/chat/new', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                const data = await response.json();
                if (data.success) {
                    currentChatId = data.chatId;
                    updateStatus('Connected to chat session');
                } else {
                    throw new Error(data.error || 'Failed to start chat session');
                }
            } catch (error) {
                updateStatus('Error: ' + error.message, true);
                console.error("New Chat API Error:", error);
            }
        }

        async function sendMessage(message, isLessonContent = false) {

            console.log(message);
            if (!currentChatId) {
                updateStatus('No active chat session', true);
                return;
            }

            // Append the user message to chat history only if it's not lesson content initiated by the system
            if (!isLessonContent) {
                appendMessage(message, 'user');
            }

            try {
                disableInput(true);
                aiTypingIndicator.classList.remove('hidden');
                chatContainer.scrollTop = chatContainer.scrollHeight;

                const fullMessage = `Rewrite this piece of knowledge for the student to learn better: “${message}. " This paragraph is meant to be implemented directly to a learning app, so don't add any unnecessary paragraphs or quotation marks. Structure the content with markdown format. Answer with medium to advanced knowledge. Highlight 2-3 most important word/sentence with inline em format if necessary. Don't answer this prompt in the response.`;

                const response = await fetch('https://server-ef04.onrender.com/api/chat/message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        chatId: currentChatId,
                        message: fullMessage
                    })
                });

                const data = await response.json();
                if (data.success) {
                    appendMessage(data.response, 'ai');
                } else {
                    throw new Error(data.error || 'Failed to get response');
                }
            } catch (error) {
                updateStatus('Error: ' + error.message, true);
                console.error("AI API Error:", error);
            } finally {
                disableInput(false);
                aiTypingIndicator.classList.add('hidden');
                if (!isLessonContent) { // Only clear input if it was a direct user message
                    chatInput.value = '';
                }
                saveProgress();
            }
        }


        // --- UI HELPER FUNCTIONS ---
        function appendMessage(message, sender, fromLoad = false) {
            const messageWrapper = document.createElement('div');
            messageWrapper.classList.add('message-wrapper');

            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message');

            if (sender === 'user') {
                messageWrapper.classList.add('self-end', 'justify-end');
                messageDiv.classList.add('user-message');
                messageWrapper.appendChild(messageDiv);
            } else if (sender === 'ai-newchapter') {
                messageWrapper.classList.add('self-start', 'justify-start');
                messageDiv.classList.add('ai-message', 'ai-newchapter-message');
                messageWrapper.appendChild(messageDiv);
            } else if (sender === 'ai-newsection') {
                messageWrapper.classList.add('self-start', 'justify-start');
                messageDiv.classList.add('ai-message', 'ai-newsection-message'); // Using specific class
                messageWrapper.appendChild(messageDiv);
            } else { // Default to 'ai' for paragraph content or general AI responses
                messageWrapper.classList.add('self-start', 'justify-start');
                const avatarImg = document.createElement('img');
                avatarImg.classList.add('ai-avatar');
                avatarImg.src = "https://placehold.co/32x32/FF8585/white?text=AI";
                avatarImg.alt = "AI Avatar";
                messageWrapper.appendChild(avatarImg);
                messageDiv.classList.add('ai-message');
                messageWrapper.appendChild(avatarImg); // Append avatar first
                messageWrapper.appendChild(messageDiv); // Then message div
            }

            messageDiv.innerHTML = marked.parse(message);

            chatContainer.appendChild(messageWrapper);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            if (!fromLoad) {
                chatHistoryData.push({
                    text: message,
                    sender: sender
                });
            }
        }

        function updateStatus(message, isError = false) {
            statusMessageDiv.textContent = message;
            if (isError) {
                statusMessageDiv.classList.add('error-message');
            } else {
                statusMessageDiv.classList.remove('error-message');
            }
        }

        function disableInput(disabled) {
            chatInput.disabled = disabled;
            sendButton.disabled = disabled;
            voiceInputBtn.disabled = disabled; // Disable voice input too
            clearChatBtn.disabled = disabled; // Disable clear chat button
            explainBtn.disabled = disabled;
            quizBtn.disabled = disabled;
            nextSectionBtn.disabled = disabled; // Control next section button
            prevChapterBtn.disabled = disabled; // Disable chapter navigation during AI response
            nextChapterBtn.disabled = disabled; // Disable chapter navigation during AI response
            unitSelect.disabled = disabled; // Disable unit/subject selection during AI response
            subjectList.querySelectorAll('li').forEach(li => {
                li.style.pointerEvents = disabled ? 'none' : 'auto';
                li.style.opacity = disabled ? '0.7' : '1';
            });
            chapterSelect.disabled = disabled;
        }

        // --- SYLLABUS AND LESSON MANAGEMENT ---

        function populateSubjectList() {
            subjectList.innerHTML = '';
            Object.keys(syllabus).forEach(subject => {
                const li = document.createElement('li');
                li.textContent = subject;
                li.classList.add('px-4', 'py-2', 'rounded-lg', 'text-gray-700', 'hover:bg-gray-200', 'transition-colors', 'text-sm', 'dark:text-gray-200', 'dark:hover:bg-gray-700');
                if (subject === currentSubject) {
                    li.classList.add('bg-gray-200', 'font-bold', 'dark:bg-gray-700');
                }
                li.addEventListener('click', () => selectSubject(subject));
                subjectList.appendChild(li);
            });
        }

        function selectSubject(subject) {
            currentSubject = subject;
            currentUnitIndex = 1;
            currentChapterIndex = 0;
            currentSectionIndex = 0;
            lessonInProgress = false;
            chatHistoryData = [];
            populateSubjectList();
            populateUnitSelect(); // Re-populate units based on new subject
            startLesson();
            saveProgress();
        }

        function populateUnitSelect() {
            unitSelect.innerHTML = '';
            const units = syllabus[currentSubject].units;
            Object.keys(units).forEach(unitNum => {
                const option = document.createElement('option');
                option.value = unitNum;
                option.textContent = `Unit ${unitNum}: ${units[unitNum].title}`;
                unitSelect.appendChild(option);
            });
            // Set the selected unit after populating
            unitSelect.value = currentUnitIndex;
        }

        function populateChapterSelect() {
            chapterSelect.innerHTML = '';
            const unit = syllabus[currentSubject].units[currentUnitIndex];
            if (!unit || !unit.chapters || unit.chapters.length === 0) {
                chapterSelectionSection.classList.add('hidden');
                return;
            }

            chapterSelectionSection.classList.remove('hidden');

            unit.chapters.forEach((chapter, index) => {
                const option = document.createElement('option');
                option.value = index; // Use index as value
                // Add chapter number consistently, the parsing function already stripped original numbering
                option.textContent = `${index + 1}. ${chapter.title}`;
                chapterSelect.appendChild(option);
            });
            chapterSelect.value = currentChapterIndex; // Set current chapter
            updateSectionProgressBar(); // Update progress bar
        }

        function updateSectionProgressBar() {
            const unit = syllabus[currentSubject].units[currentUnitIndex];
            if (!unit || !unit.chapters || unit.chapters.length === 0) {
                sectionProgressBar.style.width = '0%';
                return;
            }
            const chapter = unit.chapters[currentChapterIndex];
            if (!chapter || !chapter.sections || chapter.sections.length === 0) {
                sectionProgressBar.style.width = '0%';
                return;
            }

            const totalSections = chapter.sections.length;
            const progress = (currentSectionIndex / totalSections) * 100;
            sectionProgressBar.style.width = `${progress}%`;
        }

        function startLesson() {
            chatContainer.innerHTML = '';
            chatHistoryData = [];
            appendMessage(`Hello! Welcome to AI Teach for ${currentSubject} Unit ${currentUnitIndex}. Let's begin our lesson!`, 'ai');
            lessonInProgress = true;
            endingScreen.classList.add('hidden');
            actionButtonsContainer.classList.remove('hidden');

            const unit = syllabus[currentSubject].units[currentUnitIndex];
            if (unit && unit.chapters && unit.chapters.length > 0) {
                currentChapterIndex = Math.min(currentChapterIndex, unit.chapters.length - 1);
                const chapter = unit.chapters[currentChapterIndex];
                if (chapter && chapter.sections && chapter.sections.length > 0) {
                    currentSectionIndex = Math.min(currentSectionIndex, chapter.sections.length - 1);
                } else {
                    currentSectionIndex = 0;
                }
            } else {
                currentChapterIndex = 0;
                currentSectionIndex = 0;
                actionButtonsContainer.classList.add('hidden'); // No content to teach
                appendMessage("No content available for this unit.", "ai");
                return;
            }

            populateChapterSelect(); // Populate chapter dropdown
            teachCurrentSection(); // Start teaching the first section
        }

        async function teachCurrentSection() {
            const unit = syllabus[currentSubject].units[currentUnitIndex];
            if (!unit || !unit.chapters) {
                appendMessage("Error: Unit or chapters not found.", "ai");
                return;
            }

            const chapter = unit.chapters[currentChapterIndex];
            if (!chapter) {
                endUnit(); // All chapters done
                return;
            }

            const section = chapter.sections[currentSectionIndex];
            if (!section) {
                // All sections in the current chapter are finished, move to next chapter
                goToNextChapter(); // This handles moving to next chapter or ending unit
                return;
            }

            // Always announce new chapter if it's the beginning of a chapter (section index is 0)
            if (currentSectionIndex === 0) {
                // Prepend chapter number
                appendMessage(`${currentChapterIndex + 1}. ${chapter.title}`, 'ai-newchapter');
            }
            // Announce new section
            appendMessage(`${section.title}`, 'ai-newsection');


            // Join all paragraphs of the current section to send to the AI
            const sectionContent = section.paragraphs.join('\n\n');
            const prompt = `Please paraphrase the following content with a ${selectedTone} tone, ensuring it's comprehensive and highlights key points:\n\n${sectionContent}`;

            await sendMessage(prompt, true); // Send as lesson content
            disableInput(false);

            nextSectionBtn.textContent = (currentSectionIndex === chapter.sections.length - 1 &&
                currentChapterIndex === unit.chapters.length - 1) ? "Finish Unit" : "Next Section";

            updateSectionProgressBar();
            saveProgress();
        }

        function explainCurrentSection() {
            const unit = syllabus[currentSubject].units[currentUnitIndex];
            const chapter = unit.chapters[currentChapterIndex];
            const section = chapter.sections[currentSectionIndex];
            console.log(hi);
            console.log(section);
            console.log(section.title);
            if (section) {
                sendMessage(`You are an Edexcel IAL Chemistry teaching assistant. Teach "${section.title}" with a ${selectedTone} tone.`);
            } else {
                appendMessage("Please select a subject and unit to start learning.", "ai");
            }
        }

        function quizCurrentSection() {
            const unit = syllabus[currentSubject].units[currentUnitIndex];
            const chapter = unit.chapters[currentChapterIndex];
            const section = chapter.sections[currentSectionIndex];
            if (section) {
                sendMessage(`Give me a quiz question on "${section.title}" with a ${selectedTone} tone.`);
            } else {
                appendMessage("Please select a subject and unit to start learning.", "ai");
            }
        }

        function goToNextSection() {
            const unit = syllabus[currentSubject].units[currentUnitIndex];
            const chapter = unit.chapters[currentChapterIndex];

            currentSectionIndex++;
            if (currentSectionIndex < chapter.sections.length) {
                teachCurrentSection(); // Teach first paragraph of new section
            } else {
                // All sections in this chapter are done, move to next chapter
                goToNextChapter();
            }
            saveProgress();
        }

        function goToNextChapter() {
            const unit = syllabus[currentSubject].units[currentUnitIndex];
            currentChapterIndex++;
            currentSectionIndex = 0; // Reset section index for new chapter

            if (currentChapterIndex < unit.chapters.length) {
                chatContainer.innerHTML = ''; // Clear chat for new chapter
                chatHistoryData = []; // Clear history for new chapter
                populateChapterSelect(); // Update chapter dropdown
                teachCurrentSection(); // Teach first section of new chapter
            } else {
                // All chapters in the unit are finished
                endUnit();
            }
            saveProgress();
        }

        function goToPreviousChapter() {
            const unit = syllabus[currentSubject].units[currentUnitIndex];
            if (currentChapterIndex > 0) {
                currentChapterIndex--;
                currentSectionIndex = 0; // Reset section index for new chapter
                chatContainer.innerHTML = ''; // Clear chat for new chapter
                chatHistoryData = []; // Clear history for new chapter
                populateChapterSelect();
                appendMessage(`Returning to Chapter: ${currentChapterIndex + 1}. ${unit.chapters[currentChapterIndex].title}`, 'ai');
                teachCurrentSection();
            } else {
                appendMessage("You are at the first chapter.", "ai");
            }
            saveProgress();
        }

        function selectChapter(chapterIndex) {
            currentChapterIndex = parseInt(chapterIndex);
            currentSectionIndex = 0; // Reset section index for selected chapter
            chatContainer.innerHTML = ''; // Clear chat for new chapter
            chatHistoryData = []; // Clear history for new chapter
            populateChapterSelect(); // Update dropdown selection and progress bar
            const unit = syllabus[currentSubject].units[currentUnitIndex];
            appendMessage(`Jumping to Chapter: ${currentChapterIndex + 1}. ${unit.chapters[currentChapterIndex].title}`, 'ai');
            teachCurrentSection();
            saveProgress();
        }


        function endUnit() {
            lessonInProgress = false;
            endingScreen.classList.remove('hidden');
            actionButtonsContainer.classList.add('hidden');
            const nextUnitExists = syllabus[currentSubject].units[currentUnitIndex + 1] !== undefined;
            nextUnitBtn.disabled = !nextUnitExists;
            saveProgress(); // Ensure final state is saved
        }

        function restartCurrentUnit() {
            currentChapterIndex = 0;
            currentSectionIndex = 0;
            endingScreen.classList.add('hidden');
            startLesson();
        }

        function goToNextUnit() {
            const nextUnitNum = currentUnitIndex + 1;
            if (syllabus[currentSubject].units[nextUnitNum]) {
                currentUnitIndex = nextUnitNum;
                currentChapterIndex = 0; // Start at the first chapter of the new unit
                currentSectionIndex = 0; // Start at the first section of the new unit
                endingScreen.classList.add('hidden');
                populateUnitSelect();
                startLesson(); // This will clear chat and restart lesson for the new unit
            } else {
                appendMessage("You have completed all units for this subject!", "ai");
                nextUnitBtn.disabled = true;
            }
            saveProgress();
        }

        // --- VOICE RECOGNITION ---
        function setupVoiceRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                statusMessageDiv.textContent = 'Speech recognition not supported in this browser.';
                voiceInputBtn.disabled = true;
                return;
            }

            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;

            recognition.onstart = () => {
                isRecognizing = true;
                voiceInputBtn.classList.add('bg-red-500', 'hover:bg-red-600');
                voiceInputBtn.innerHTML = '<i class="fas fa-microphone-slash"></i>';
                updateStatus('Listening...');
            };

            recognition.onresult = (event) => {
                let interimTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        chatInput.value = event.results[i][0].transcript;
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                updateStatus('Speech recognition error: ' + event.error, true);
                isRecognizing = false;
                voiceInputBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
                voiceInputBtn.innerHTML = '<i class="fas fa-microphone"></i>';
            };

            recognition.onend = () => {
                isRecognizing = false;
                voiceInputBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
                voiceInputBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                updateStatus('Click microphone to speak');
            };

            voiceInputBtn.addEventListener('click', () => {
                if (isRecognizing) {
                    recognition.stop();
                } else {
                    if (recognition.recognizing) {
                        recognition.stop();
                    }
                    recognition.start();
                }
            });
        }

        // --- TONE SELECTION MODAL FUNCTIONS ---
        function openToneModal() {
            toneModalOverlay.classList.remove('hidden');
        }

        function closeToneModal() {
            toneModalOverlay.classList.add('hidden');
        }

        function handleToneSelection(event) {
            const targetLabel = event.target.closest('.tone-option');
            if (targetLabel) {
                selectedTone = targetLabel.dataset.tone;
                document.querySelectorAll('.tone-option').forEach(opt => opt.classList.remove('selected'));
                targetLabel.classList.add('selected');
                saveProgress(); // Save the new tone preference
            }
        }

        /**
         * Clears all messages from the chat interface and resets the chat history.
         */
        function clearChatHistory() {
            chatContainer.innerHTML = ''; // Clear UI
            chatHistoryData = []; // Clear data
            appendMessage('Chat history cleared. How can I help you learn today?', 'ai');
            saveProgress(); // Save the cleared history
        }


        // --- EVENT LISTENERS ---
        sendButton.addEventListener('click', () => {
            const message = chatInput.value.trim();
            if (message) {
                sendMessage(message, false); // Not lesson content
                if (isRecognizing) recognition.stop();
            }
        });

        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const message = chatInput.value.trim();
                if (message) {
                    sendMessage(message, false); // Not lesson content
                    if (isRecognizing) recognition.stop();
                }
            }
        });

        unitSelect.addEventListener('change', (e) => {
            currentUnitIndex = parseInt(e.target.value);
            currentChapterIndex = 0;
            currentSectionIndex = 0;
            chatHistoryData = []; // Clear chat history on unit change
            startLesson();
            saveProgress();
        });

        chapterSelect.addEventListener('change', (e) => {
            selectChapter(e.target.value);
        });

        prevChapterBtn.addEventListener('click', goToPreviousChapter);
        nextChapterBtn.addEventListener('click', goToNextChapter);

        explainBtn.addEventListener('click', explainCurrentSection);
        quizBtn.addEventListener('click', quizCurrentSection);
        nextSectionBtn.addEventListener('click', goToNextSection); // Now for next section
        restartUnitBtn.addEventListener('click', restartCurrentUnit);
        nextUnitBtn.addEventListener('click', goToNextUnit);

        openToneModalBtn.addEventListener('click', openToneModal);
        closeToneModalBtn.addEventListener('click', closeToneModal);
        toneOptions.addEventListener('change', handleToneSelection); // Use change event on parent for radio buttons
        clearChatBtn.addEventListener('click', clearChatHistory); // New event listener for clear chat button

        // --- INITIALIZATION ---
        async function initializeAITeach() {
            populateSubjectList();
            setupVoiceRecognition();
            await startNewChat(); // Ensure chat session is established before loading progress

            if (!loadProgress()) {
                // If no progress loaded, currentUnitIndex will be default (1)
                populateUnitSelect(); // Populate for default state
                startLesson();
            } else {
                // If progress loaded, currentUnitIndex is updated by loadProgress
                populateUnitSelect(); // Re-populate and set value for loaded state
                // If a lesson was in progress, ensure correct UI state
                const unit = syllabus[currentSubject].units[currentUnitIndex];
                if (lessonInProgress && unit && unit.chapters && unit.chapters.length > 0) {
                    const chapter = unit.chapters[currentChapterIndex];
                    if (chapter && chapter.sections && chapter.sections.length > 0) {
                        // All good, context is loaded
                    }
                    actionButtonsContainer.classList.remove('hidden');
                    disableInput(false);
                } else if (!lessonInProgress && unit && currentChapterIndex >= unit.chapters.length) {
                    endUnit();
                }
            }
            populateChapterSelect(); // Always populate chapter select on init to ensure correct state
            updateSectionProgressBar(); // Update progress bar on init
            saveProgress(); // Ensure initial state or loaded state is saved
        }

        initializeAITeach();

        // Dark mode preference check
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
    </script>
</body>

</html>
