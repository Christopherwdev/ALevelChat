<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <title>Paper Viewer</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script>
        /* Tailwind configuration for custom colors and dark mode */
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#FF3B30',
                        biology: '#0FBD8C',
                        chemistry: '#FF8585',
                        physics: '#4081FF',
                        math: '#FFAB1A',
                        chinese: '#9C27B0'
                    },
                },
            },
        };
        </script>
<style>
        /* Custom styles for the app */
        :root {
            --primary-color: #FF3B30; /* Ensure this matches tailwind.config.theme.extend.colors.primary */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
            color: #333;
            overflow: hidden; /* Prevent body scroll, content will scroll */
        }
        .dark body {
            background-color: #1a202c; /* gray-900 */
            color: #e2e8f0; /* gray-200 */
        }
        .pdf-frame {
            width: 100%;
            height: 100%;
            border: none;
        }
        .answer-area {
            background-color: #ffffff;
            border-left: 1px solid #e2e8f0;
            padding: 1rem;
            display: flex;
            flex-direction: column;
        }
        .dark .answer-area {
            background-color: #2d3748; /* gray-800 */
            border-left-color: #4a5568; /* gray-700 */
        }
        textarea {
            flex-grow: 1; /* Make textarea fill available space */
            width: 100%;
            border: 1px solid #cbd5e1;
            border-radius: 0.375rem;
            padding: 0.75rem;
            resize: none; /* Disable manual resize */
            font-family: 'Inter', sans-serif;
            font-size: 0.9rem;
            line-height: 1.5;
            background-color: #f7fafc;
            color: #1a202c;
        }
        .dark textarea {
            background-color: #4a5568; /* gray-700 */
            color: #e2e8f0; /* gray-200 */
            border-color: #4a5568; /* gray-700 */
        }
        .timer-display {
            font-variant-numeric: tabular-nums; /* Align numbers in monospace font */
        }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.7);
        }
        /* Style for active buttons in the navbar modes/layouts */
        .nav-btn-active {
            background-color: var(--primary-color);
            color: white;
        }
        .nav-btn-inactive {
            background-color: rgb(243 244 246); /* Tailwind gray-100 */
            color: rgb(55 65 81); /* Tailwind gray-700 */
        }
        .dark .nav-btn-inactive {
            background-color: rgb(55 65 81); /* Tailwind gray-700 */
            color: rgb(229 231 235); /* Tailwind gray-200 */
        }

        /* Specific styles for the new audio overlay button and player */
        .audio-toggle-button {
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background-color: #007bff; /* Blue for visibility */
            color: white;
            font-size: 1.5rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
        }
        .audio-toggle-button:hover {
            background-color: #0056b3;
            transform: scale(1.05);
        }
        

        .audio-player-compact {
            width: 300px; /* Limit width */
            padding: 1rem;
            background-color: white;
            border-radius: 0.75rem; /* rounded-lg */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-xl */
            display: flex;
            flex-direction: column;
            gap: 0.75rem; /* space-y-3 */
        }
        .dark .audio-player-compact {
            background-color: #2d3748; /* gray-800 */
        }
        .audio-player-compact audio {
            width: 100%;
            height: 30px;
        }
        .audio-player-compact .language-options label {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }
        .audio-player-compact .language-options input[type="radio"] {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            width: 1rem;
            height: 1rem;
            border: 2px solid #ccc;
            border-radius: 50%;
            outline: none;
            transition: border-color 0.2s;
            position: relative;
        }
        .audio-player-compact .language-options input[type="radio"]:checked {
            border-color: #007bff;
        }
        .audio-player-compact .language-options input[type="radio"]:checked::before {
            content: '';
            width: 0.5rem;
            height: 0.5rem;
            background-color: #007bff;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
    </style>
</head>
<body class="antialiased h-screen flex flex-col">
    <!-- Top Navbar -->
    <nav class="flex-shrink-0 bg-white dark:bg-gray-800 border-b dark:border-gray-700 p-4 flex items-center justify-between shadow-sm">
        <div class="flex items-center space-x-4">
            <!-- Back Button to previous page -->
            <button id="back-btn" class="p-2 rounded-full text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 hover:text-gray-800 dark:hover:text-gray-200 transition">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 17l-5-5m0 0l5-5m-5 5h12" />
                </svg>
            </button>
            <h1 id="paper-title" class="text-xl font-bold text-gray-800 dark:text-gray-200">Loading Paper...</h1>
        </div>

        <div class="flex items-center justify-end space-x-6 grow">
            <!-- Timer Section -->
            <div class="flex items-center space-x-0 bg-[#00000010] pl-4 rounded-full">
                <span id="timer-display" class="timer-display text-2xl font-mono font-bold text-gray-900 dark:text-gray-100 mr-4">00:00:00</span>
                <button id="timer-play-pause-btn" class="p-2 rounded-full hover:bg-[#00000010] dark:hover:bg-gray-700 transition w-[40px] h-[40px]" title="Play/Pause Timer">
                    <svg id="play-icon" class="h-6 w-6 text-green-500" fill="currentColor" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
                    <svg id="pause-icon" class="h-6 w-6 text-yellow-500 hidden" fill="currentColor" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
                </button>
                <button id="timer-reset-btn" class="p-2 rounded-full hover:bg-[#00000010] dark:hover:bg-gray-700 transition w-[40px] h-[40px]" title="Reset Timer">
                    <i class="fas fa-stop-circle"></i>
                </button>
                <button id="timer-set-btn" class="p-0 rounded-full hover:bg-[#00000010] dark:hover:bg-gray-700 transition w-[40px] h-[40px]" title="Set Timer">
                    <i class="fas fa-sliders"></i>
                </button>
            </div>

            <!-- Mode Selection -->
            <div class="flex bg-gray-100 dark:bg-gray-700 rounded-lg p-1 gap-1">
                <button id="mode-do-paper-btn" class="px-4 py-2 text-sm font-medium rounded-md nav-btn-active transition">Do Paper</button>
                <button id="mode-review-paper-btn" class="px-4 py-2 text-sm font-medium rounded-md nav-btn-inactive transition">Review Paper</button>
            </div>

            <!-- Layout Selection -->
            <div class="flex bg-gray-100 dark:bg-gray-700 rounded-lg p-1 gap-1">
                <button id="layout-full-btn" class="px-4 py-2 text-sm font-medium rounded-md nav-btn-inactive transition" title="Full Screen Layout">
                    <i class="fas fa-window-maximize"></i>
                </button>
                <button id="layout-split-btn" class="px-4 py-2 text-sm font-medium rounded-md nav-btn-active transition" title="Split Screen Layout">
                    <i class="fas fa-columns"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content Area -->
    <div id="content-area" class="flex-grow flex overflow-hidden">
        <!-- Question Paper (QP) iframe - Left Panel -->
        <div id="qp-panel" class="flex-grow">
            <iframe id="qp-iframe" class="pdf-frame" src=""></iframe>
        </div>

        <!-- Right Panel: Answer Area or Mark Scheme (MS) iframe -->
        <div id="right-panel" class="flex-grow hidden">
            <!-- Answer area is displayed in 'Do Paper' mode (split) -->
            <textarea id="answer-textarea" class="w-full h-full p-4" placeholder="Write your answers here..."></textarea>
            <!-- Mark Scheme is displayed in 'Review Paper' mode (split or full) -->
            <iframe id="ms-iframe" class="pdf-frame" src=""></iframe>
        </div>
    </div>

    <!-- Timer Settings Modal Overlay -->
    <div id="timer-settings-modal" class="modal-overlay fixed inset-0 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 shadow-xl w-full max-w-sm">
            <h3 class="text-lg font-semibold mb-4 text-gray-800 dark:text-gray-200">Set Timer Duration</h3>
            <div class="mb-4">
                <label for="hours-input" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Hours</label>
                <input type="number" id="hours-input" min="0" max="99" value="0" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200">
            </div>
            <div class="mb-4">
                <label for="minutes-input" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Minutes</label>
                <input type="number" id="minutes-input" min="0" max="59" value="0" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200">
            </div>
            <div class="mb-6">
                <label for="seconds-input" class="block text-sm font-medium text-gray-700 dark:text-gray-200">Seconds</label>
                <input type="number" id="seconds-input" min="0" max="59" value="0" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary focus:border-primary dark:bg-gray-700 dark:border-gray-600 dark:text-gray-200">
            </div>
            <div class="flex justify-end space-x-3">
                <button id="cancel-timer-set-btn" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600 transition">Cancel</button>
                <button id="confirm-timer-set-btn" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-red-600 transition">Set Timer</button>
            </div>
        </div>
    </div>

    <!-- Audio Player Overlay (New Implementation) -->
    <div id="audio-overlay-container" class="fixed bottom-4 left-4 z-50 flex items-end gap-3">
        <!-- Circular button to toggle the compact audio player -->
        <button id="toggle-audio-player-btn" class="audio-toggle-button hidden">
            <i class="fas fa-headphones"></i>
        </button>

        <!-- Compact audio player and language selection -->
        <div id="compact-audio-player" class="audio-player-compact hidden">
            <div class="flex justify-between items-center">
                <h3 class="text-md font-semibold text-gray-800 dark:text-gray-200">Listening Recording</h3>
                <button id="close-compact-audio-player-btn" class="text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <audio id="audio-player" controls class="w-full">
                Your browser does not support the audio element.
            </audio>
            <div class="language-options flex justify-around text-gray-700 dark:text-gray-200 text-sm">
                <label>
                    <input type="radio" name="audio-language" value="Mandarin" checked> Mandarin
                </label>
                <label>
                    <input type="radio" name="audio-language" value="Cantonese"> Cantonese
                </label>
            </div>
          
        </div>
    </div>

    <script>
        // --- CONSTANTS ---
        // Base URL for the PDF files
        const BASE_PDF_URL = 'https://www.aiaiblock.com/AIToLearn/PastPaperNew';
        // Mapping for abbreviated month to full month name for filename construction
        const EXAM_MONTH_MAP = {
            'Jan': 'January',
            'Jun': 'June',
            'Oct': 'October',
            'Nov': 'November'
        };

        // Subject code prefixes for IAL
        const IAL_SUBJECT_PREFIXES = {
            'Physics': 'WPH',
            'Chemistry': 'WCH',
            'Biology': 'WBI'
        };

        // Default timer durations in seconds
        const DEFAULT_DURATIONS_SECONDS = {
            'Math': (1 * 3600) + (30 * 60), // 1 hour 30 minutes
            'OtherSubjects': {
                'Unit 1-2': (1 * 3600) + (30 * 60), // 1 hour 30 minutes
                'Unit 3/6': (1 * 3600) + (20 * 60), // 1 hour 20 minutes
                'Unit 4-5': (1 * 3600) + (45 * 60),  // 1 hour 45 minutes

                'Chi Paper 1': (0 * 3600) + (30 * 60),
                'Chi Paper 2': (1 * 3600) + (45 * 60)
            }
        };

        // --- DOM Elements ---
        const paperTitle = document.getElementById('paper-title');
        const qpIframe = document.getElementById('qp-iframe');
        const msIframe = document.getElementById('ms-iframe');
        const answerTextarea = document.getElementById('answer-textarea');
        const qpPanel = document.getElementById('qp-panel');
        const rightPanel = document.getElementById('right-panel');

        const modeDoPaperBtn = document.getElementById('mode-do-paper-btn');
        const modeReviewPaperBtn = document.getElementById('mode-review-paper-btn');
        const layoutFullBtn = document.getElementById('layout-full-btn');
        const layoutSplitBtn = document.getElementById('layout-split-btn');

        const timerDisplay = document.getElementById('timer-display');
        const timerPlayPauseBtn = document.getElementById('timer-play-pause-btn');
        const timerResetBtn = document.getElementById('timer-reset-btn');
        const timerSetBtn = document.getElementById('timer-set-btn');
        const playIcon = document.getElementById('play-icon');
        const pauseIcon = document.getElementById('pause-icon');

        const timerSettingsModal = document.getElementById('timer-settings-modal');
        const hoursInput = document.getElementById('hours-input');
        const minutesInput = document.getElementById('minutes-input');
        const secondsInput = document.getElementById('seconds-input');
        const cancelTimerSetBtn = document.getElementById('cancel-timer-set-btn');
        const confirmTimerSetBtn = document.getElementById('confirm-timer-set-btn');
        const backBtn = document.getElementById('back-btn');

        // New Audio Player DOM Elements (updated for overlay)
        const toggleAudioPlayerBtn = document.getElementById('toggle-audio-player-btn'); // The circular button
        const compactAudioPlayer = document.getElementById('compact-audio-player');   // The compact player container
        const audioPlayer = document.getElementById('audio-player');
        const closeCompactAudioPlayerBtn = document.getElementById('close-compact-audio-player-btn');
        const audioLanguageRadios = document.querySelectorAll('input[name="audio-language"]');


        // --- State Variables ---
        let currentMode = 'doPaper';      // 'doPaper' or 'reviewPaper'
        let currentLayout = 'splitScreen'; // 'fullScreen' or 'splitScreen'
        let timerInterval;               // Stores the setInterval ID for the timer
        let totalSeconds = 0;            // Current time left on the countdown
        let initialTotalSeconds = 0;     // Stores the default/last manually set time for reset
        let isTimerRunning = false;      // Flag to track timer state
        let initialPdfType = '';         // 'qp' or 'ms', derived from URL to set initial mode

        // Object to store paper data passed via URL parameters
        let paperData = {
            subject: '',
            paper: '',
            series: '',
            year: '',
            examBoard: '',
            examLevel: ''
        };

        // --- Helper Functions ---

        /**
         * Parses URL query parameters into a plain JavaScript object.
         * @returns {Object} An object containing all URL parameters as key-value pairs.
         */
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            const data = {};
            for (const [key, value] of params.entries()) {
                data[key] = value;
            }
            return data;
        }

        /**
         * Returns the full month name from its abbreviation.
         * @param {string} abbr - The abbreviated month name (e.g., 'Jan', 'Jun', 'Oct').
         * @returns {string} The full month name (e.g., 'January', 'June', 'October').
         */
        function getFullMonthName(abbr) {
            return EXAM_MONTH_MAP[abbr] || abbr; // Fallback to abbreviation if not found
        }

        /**
         * Determines the specific paper code (e.g., WPH14, WMA11) based on subject and paper name.
         * @param {string} subject - The subject of the paper (e.g., 'Physics', 'Math').
         * @param {string} paper - The paper identifier (e.g., 'Unit 4', 'P1', 'M1').
         * @returns {string} The formatted paper code, or an empty string if no match.
         */
        function getSpecificPaperCode(subject, paper) {
            if (subject === 'Math') {
                const paperPrefixMatch = paper.match(/^(P|M|FP|S|D)/i);
                const paperNumberMatch = paper.match(/\d+$/);

                if (!paperPrefixMatch || !paperNumberMatch) return '';

                const prefixChar = paperPrefixMatch[1].toUpperCase();
                const number = paperNumberMatch[0];

                switch (prefixChar) {
                    case 'P': return `WMA1${number}`;
                    case 'M': return `WME0${number}`;
                    case 'S': return `WST0${number}`;
                    case 'D': return `WDM1${number}`;
                    case 'FP': // Changed from 'F' to 'FP' to match the regex group
                        return `WFM0${number}`;
                    default: return ''; // Added a default case for robustness
                }
            } else {
                const prefix = IAL_SUBJECT_PREFIXES[subject];
                const unitNumberMatch = paper.match(/Unit\s*(\d+)/i); // e.g., "Unit 4" -> "4"
                if (prefix && unitNumberMatch && unitNumberMatch[1]) {
                    return `${prefix}1${unitNumberMatch[1]}`; // e.g., WCH14
                }
            }
            return ''; // Default or error case
        }

        /**
         * Constructs the full URL for either the Question Paper (QP) or Mark Scheme (MS) PDF.
         * The URL structure is based on the provided aiaiblock.com pattern, incorporating
         * abbreviated month for directory and full paper codes for filenames.
         * @param {string} type - 'qp' for Question Paper, 'ms' for Mark Scheme.
         * @returns {string} The complete URL to the PDF file.
         */
        function getPdfUrl(type) {
            const abbreviatedMonth = paperData.series; // e.g., 'Jan' (for directory)
            const fullMonth = getFullMonthName(paperData.series); // e.g., 'January' (for filename)
            const year = paperData.year;
            const subject = paperData.subject;
            const paper = paperData.paper;
            const examLevel = paperData.examLevel; // Get exam level

            // Determine filename prefix and folder based on type
            const folder = type === 'qp' ? 'Question-paper' : 'Mark-scheme';
            const filenamePrefix = type === 'qp' ? 'Questionpaper' : 'Markscheme';

            let filenameIdentifier = ''; // This will be "UnitX" or "PaperX" or "P1", "1C" etc.

            if (examLevel === 'IGCSE') {
                // For IGCSE, use "PaperX" or just the paper string directly if not starting with "Unit"
                const paperNumberMatch = paper.match(/\d+$/); // e.g., "Paper 1" -> "1", "1P" -> "1"
                if (paper.toLowerCase().startsWith('paper') && paperNumberMatch) {
                    filenameIdentifier = `Paper${paperNumberMatch[0]}`; // e.g., "Paper1"
                } else {
                    // For IGCSE papers like "1P", "2C", "1F", "1H" etc.
                    filenameIdentifier = paper.replace(/\s+/g, '');
                }
            } else { // IAL
                if (subject === 'Math') {
                    // For IAL Math papers like P1, M2, D2, FP3, extract the number and prepend "Unit"
                    const mathPaperNumberMatch = paper.match(/\d+$/);
                    if (mathPaperNumberMatch) {
                        filenameIdentifier = `Unit${mathPaperNumberMatch[0]}`;
                    } else {
                        // Fallback for any unexpected math paper names (should ideally not happen if data is consistent)
                        filenameIdentifier = paper.replace(/\s+/g, '');
                    }
                } else {
                    // For other IAL subjects (Physics, Chemistry, Biology), check for "Unit X"
                    const unitMatch = paper.match(/Unit\s*(\d+)/i);
                    if (unitMatch) {
                        filenameIdentifier = `Unit${unitMatch[1]}`;
                    } else {
                        // Fallback for non-math IAL papers that don't follow "Unit X" (if any exist)
                        filenameIdentifier = paper.replace(/\s+/g, '');
                    }
                }
            }

            // Get the specific code like WMA11 or WCH14
            const specificPaperCode = getSpecificPaperCode(subject, paper);

            // Construct the base of the filename (e.g., "Questionpaper-Unit4" or "Questionpaper-Paper1" or "Questionpaper-P1")
            let filenameBase = `${filenamePrefix}-${filenameIdentifier}`;

            // Add the specific paper code in parentheses if available
            const codePart = specificPaperCode ? `(${specificPaperCode})` : '';

            // Construct the full URL
            const url = `${BASE_PDF_URL}/${subject}/${year} ${abbreviatedMonth}/${folder}/${filenameBase}${codePart}-${fullMonth}${year}.pdf`;

            // Log the generated URL for debugging
            console.log(`Generated PDF URL for ${type}: ${url}`);

            return url;
        }

        /**
         * Constructs the full URL for the listening audio MP3 for Chinese papers.
         * @param {string} series - The abbreviated month series (e.g., 'Nov').
         * @param {string} year - The year (e.g., '2023').
         * @param {string} language - The language of the recording (e.g., 'Mandarin', 'Cantonese').
         * @returns {string} The complete URL to the MP3 file.
         */
        function getAudioUrl(series, year, language) {
            const abbreviatedMonth = series;
            const fullMonth = getFullMonthName(series);
            const paperNumber = paperData.paper.replace(/\s/g, ''); // "Paper 1" -> "Paper1"

            // Construct the full URL for the audio file
            // Example: https://www.aiaiblock.com/AIToLearn/PastPaperNew/Chinese/2023 Nov/Listening-Examinations-MP3/Recording-Paper1(Mandarin)-November2023.mp3
            const url = `${BASE_PDF_URL}/Chinese/${year} ${abbreviatedMonth}/Listening-Examinations-MP3/Recording-${paperNumber}(${language})-${fullMonth}${year}.mp3`;
            console.log(`Generated Audio URL: ${url}`);
            return url;
        }


        /**
         * Sets the default timer duration based on the paper's subject and unit.
         * Updates `initialTotalSeconds` and `totalSeconds`.
         */
        function setDefaultTimerDuration() {
            const subject = paperData.subject;
            const paper = paperData.paper;
            let durationInSeconds = 0;

            if (subject === 'Math') {
                durationInSeconds = DEFAULT_DURATIONS_SECONDS.Math;
            }
            else if (subject === 'Chinese') {

                const unitMatch = paper.match(/Paper\s*(\d+)/i);

                if (unitMatch && unitMatch[1]) {
                    const unitNumber = parseInt(unitMatch[1]);
                    if (unitNumber === 1 ) {
                        durationInSeconds = DEFAULT_DURATIONS_SECONDS.OtherSubjects['Chi Paper 1'];
                    } else if (unitNumber === 2) {
                        durationInSeconds = DEFAULT_DURATIONS_SECONDS.OtherSubjects['Chi Paper 2'];
                    }
                } else {

                    durationInSeconds = DEFAULT_DURATIONS_SECONDS.OtherSubjects['Unit 1-2'];
                }


            }
            else {
                const unitMatch = paper.match(/Unit\s*(\d+)/i);
                if (unitMatch && unitMatch[1]) {
                    const unitNumber = parseInt(unitMatch[1]);
                    if (unitNumber >= 1 && unitNumber <= 2) {
                        durationInSeconds = DEFAULT_DURATIONS_SECONDS.OtherSubjects['Unit 1-2'];
                    } else if (unitNumber === 3 || unitNumber === 6) {
                        durationInSeconds = DEFAULT_DURATIONS_SECONDS.OtherSubjects['Unit 3/6'];
                    } else if (unitNumber >= 4 && unitNumber <= 5) {
                        durationInSeconds = DEFAULT_DURATIONS_SECONDS.OtherSubjects['Unit 4-5'];
                    } else {
                        // Fallback for unrecognized units, set a general default or 0
                        durationInSeconds = DEFAULT_DURATIONS_SECONDS.OtherSubjects['Unit 1-2']; // Example fallback
                    }
                } else {
                    // Fallback if paper name doesn't match "Unit X" pattern (e.g., IGCSE papers, or papers like "P1", "1F")
                    // If it's IGCSE and not a specific "Unit" paper, use Unit 1-2 default.
                    // This is a pragmatic choice as generic IGCSE papers might have varying lengths.
                    durationInSeconds = DEFAULT_DURATIONS_SECONDS.OtherSubjects['Unit 1-2'];
                }
            }
            initialTotalSeconds = durationInSeconds; // Store for reset
            totalSeconds = initialTotalSeconds;      // Set current time to default
            updateTimerDisplay(); // Update display immediately
        }

        /**
         * Initializes the paper viewer by parsing URL parameters, setting the title,
         * loading the appropriate PDFs, and configuring the initial mode and layout.
         */
        function initializePaperViewer() {
            paperData = getUrlParams();
            initialPdfType = paperData.type || 'qp'; // Default to QP if no type specified in URL

            // Check if essential paper details are missing and display an error if so.
            if (!paperData.subject || !paperData.paper || !paperData.series || !paperData.year) {
                paperTitle.textContent = "Error: Paper details missing in URL. Please go back to the previous page and select a paper.";
                // Optionally hide content area or show a detailed error message
                document.getElementById('content-area').innerHTML = '<div class="text-center text-red-500 p-8">Could not load paper. Please ensure you selected a paper from the previous page.</div>';
                return;
            }

            // Update the main title of the page with the paper details.
            paperTitle.textContent = `${paperData.subject} ${paperData.paper} (${paperData.series} ${paperData.year})`;

            // Set the source for both the Question Paper and Mark Scheme iframes.
            qpIframe.src = getPdfUrl('qp');
            msIframe.src = getPdfUrl('ms');

            // Set the initial mode based on whether 'qp' or 'ms' was clicked on the previous page.
            if (initialPdfType === 'ms') {
                setMode('reviewPaper');
            } else {
                setMode('doPaper');
            }
            // Always start in split screen for better initial usability.
            setLayout('splitScreen');

            // Set the default timer duration for the loaded paper
            setDefaultTimerDuration();

            // Check if it's IGCSE Chinese Paper 1 and show audio button
            if (paperData.subject === 'Chinese' && paperData.examLevel === 'IGCSE' && paperData.paper.toLowerCase().includes('paper 1')) {
                toggleAudioPlayerBtn.classList.remove('hidden'); // Show the circular toggle button
                // Set initial audio source to Mandarin (default selected radio)
                const initialAudioUrl = getAudioUrl(paperData.series, paperData.year, 'Mandarin');
                audioPlayer.src = initialAudioUrl;
                // DO NOT AUTOPLAY: audioPlayer.play();
            } else {
                toggleAudioPlayerBtn.classList.add('hidden'); // Hide the button if not Chinese Paper 1
            }
        }

        /**
         * Sets the current operational mode of the viewer ('doPaper' or 'reviewPaper').
         * Updates button styles and panel visibility accordingly.
         * @param {string} mode - The mode to set ('doPaper' or 'reviewPaper').
         */
        function setMode(mode) {
            currentMode = mode;
            // Apply active/inactive styles to mode buttons
            modeDoPaperBtn.classList.toggle('nav-btn-active', currentMode === 'doPaper');
            modeDoPaperBtn.classList.toggle('nav-btn-inactive', currentMode !== 'doPaper');
            modeReviewPaperBtn.classList.toggle('nav-btn-active', currentMode === 'reviewPaper');
            modeReviewPaperBtn.classList.toggle('nav-btn-inactive', currentMode !== 'reviewPaper');

            updatePanelVisibility(); // Re-render panels based on new mode
        }

        /**
         * Sets the current layout of the viewer ('fullScreen' or 'splitScreen').
         * Updates button styles and panel visibility accordingly.
         * @param {string} layout - The layout to set ('fullScreen' or 'splitScreen').
         */
        function setLayout(layout) {
            currentLayout = layout;
            // Apply active/inactive styles to layout buttons
            layoutFullBtn.classList.toggle('nav-btn-active', currentLayout === 'fullScreen');
            layoutFullBtn.classList.toggle('nav-btn-inactive', currentLayout !== 'fullScreen');
            layoutSplitBtn.classList.toggle('nav-btn-active', currentLayout === 'splitScreen');
            layoutSplitBtn.classList.toggle('nav-btn-inactive', currentLayout !== 'splitScreen');

            updatePanelVisibility(); // Re-render panels based on new layout
        }

        /**
         * Manages the visibility and sizing of the QP iframe, MS iframe, and Answer textarea.
         * This function orchestrates the layout based on `currentMode` and `currentLayout`.
         */
        function updatePanelVisibility() {
            // Reset all panels to their default hidden/full-width states
            qpPanel.classList.remove('hidden', 'w-full', 'w-1/2');
            rightPanel.classList.remove('hidden', 'w-full', 'w-1/2');
            answerTextarea.style.display = 'none'; // Hide by default
            msIframe.style.display = 'none';       // Hide by default

            if (currentMode === 'doPaper') {
                if (currentLayout === 'fullScreen') {
                    // Do Paper: QP takes full screen
                    qpPanel.classList.add('w-full');
                    rightPanel.classList.add('hidden'); // Hide the right panel entirely
                } else { // splitScreen
                    // Do Paper: QP on left (50%), Answer area on right (50%)
                    qpPanel.classList.add('w-1/2');
                    rightPanel.classList.add('w-1/2');
                    rightPanel.classList.remove('hidden'); // Ensure right panel is visible
                    answerTextarea.style.display = 'block'; // Show the answer textarea
                }
            } else { // currentMode === 'reviewPaper'
                if (currentLayout === 'fullScreen') {
                    // Review Paper: MS takes full screen
                    qpPanel.classList.add('hidden'); // Hide the QP panel entirely
                    rightPanel.classList.add('w-full');
                    rightPanel.classList.remove('hidden'); // Ensure right panel is visible
                    msIframe.style.display = 'block'; // Show the Mark Scheme iframe
                } else { // splitScreen
                    // Review Paper: QP on left (50%), MS on right (50%)
                    qpPanel.classList.add('w-1/2');
                    rightPanel.classList.add('w-1/2');
                    rightPanel.classList.remove('hidden'); // Ensure right panel is visible
                    msIframe.style.display = 'block'; // Show the Mark Scheme iframe
                }
            }
        }

        // --- Timer Functions ---

        /**
         * Formats a total number of seconds into an HH:MM:SS string.
         * @param {number} seconds - The total number of seconds to format.
         * @returns {string} The formatted time string (e.g., "01:05:30").
         */
        function formatTime(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const remainingSeconds = seconds % 60;
            return [hours, minutes, remainingSeconds]
                .map(unit => String(unit).padStart(2, '0')) // Ensure two digits
                .join(':');
        }

        /**
         * Updates the text content of the timer display element.
         */
        function updateTimerDisplay() {
            timerDisplay.textContent = formatTime(totalSeconds);
        }

        /**
         * Toggles the timer between running and paused states.
         * Updates the play/pause button icon accordingly.
         */
        function toggleTimer() {
            if (isTimerRunning) {
                clearInterval(timerInterval); // Stop the interval
                pauseIcon.classList.add('hidden');
                playIcon.classList.remove('hidden');
            } else {
                // Start a new interval, decrementing totalSeconds every second
                timerInterval = setInterval(() => {
                    if (totalSeconds > 0) {
                        totalSeconds--;
                        updateTimerDisplay();
                    } else {
                        clearInterval(timerInterval); // Stop when timer reaches zero
                        isTimerRunning = false;
                        pauseIcon.classList.add('hidden');
                        playIcon.classList.remove('hidden');
                        // Optional: Play a sound or show a "Time's up!" message
                        console.log("Time's up!");
                    }
                }, 1000);
                playIcon.classList.add('hidden');
                pauseIcon.classList.remove('hidden');
            }
            isTimerRunning = !isTimerRunning; // Flip the running state
        }

        /**
         * Resets the timer to its initial/last manually set duration, stops it, and updates the display.
         */
        function resetTimer() {
            clearInterval(timerInterval);
            isTimerRunning = false;
            totalSeconds = initialTotalSeconds; // Reset to the stored initial/set value
            updateTimerDisplay();
            // Ensure play icon is visible and pause icon is hidden
            pauseIcon.classList.add('hidden');
            playIcon.classList.remove('hidden');
        }

        /**
         * Opens the timer settings modal, pre-filling the input fields
         * with the current timer's hours, minutes, and seconds.
         */
        function openTimerSettings() {
            // Populate modal inputs with current time values
            hoursInput.value = Math.floor(totalSeconds / 3600);
            minutesInput.value = Math.floor((totalSeconds % 3600) / 60);
            secondsInput.value = totalSeconds % 60;
            timerSettingsModal.classList.remove('hidden'); // Show the modal
        }

        /**
         * Closes the timer settings modal.
         */
        function closeTimerSettings() {
            timerSettingsModal.classList.add('hidden'); // Hide the modal
        }

        /**
         * Sets the timer's total seconds based on the values entered in the modal inputs.
         * Updates `initialTotalSeconds` for future resets.
         * Resets and restarts the timer if it was running.
         */
        function setTimerFromInput() {
            const hours = parseInt(hoursInput.value) || 0;
            const minutes = parseInt(minutesInput.value) || 0;
            const seconds = parseInt(secondsInput.value) || 0;

            // Calculate new total seconds
            const newDuration = (hours * 3600) + (minutes * 60) + seconds;
            initialTotalSeconds = newDuration; // Store this as the new reset point
            totalSeconds = newDuration;         // Set current time to new duration

            updateTimerDisplay(); // Update display immediately
            closeTimerSettings(); // Close modal

            // If the timer was running, clear the old interval and start a new one
            if (isTimerRunning) {
                clearInterval(timerInterval);
                toggleTimer(); // This will restart the timer with the new `totalSeconds`
            }
        }

        // --- Audio Player Functions ---
        /**
         * Toggles the visibility of the compact audio player.
         */
        function toggleCompactAudioPlayer() {
            compactAudioPlayer.classList.toggle('hidden');
            // Audio intentionally continues to play when the compact player is hidden.
        }

        /**
         * Closes the compact audio player.
         */
        function closeCompactAudioPlayer() {
            compactAudioPlayer.classList.add('hidden');
            // Audio intentionally continues to play when the compact player is hidden.
        }

        /**
         * Updates the audio player's source based on the selected language.
         */
        function updateAudioLanguage() {
            const selectedLanguage = document.querySelector('input[name="audio-language"]:checked').value;
            const newAudioUrl = getAudioUrl(paperData.series, paperData.year, selectedLanguage);
            const wasPlaying = !audioPlayer.paused; // Check if audio was playing

            audioPlayer.src = newAudioUrl;
            audioPlayer.load(); // Reload the audio element to apply new source

            // If audio was playing, attempt to play the new source automatically
            if (wasPlaying) {
                audioPlayer.play().catch(e => console.error("Audio playback failed:", e));
            }
        }


        // --- Event Listeners ---
        modeDoPaperBtn.addEventListener('click', () => setMode('doPaper'));
        modeReviewPaperBtn.addEventListener('click', () => setMode('reviewPaper'));
        layoutFullBtn.addEventListener('click', () => setLayout('fullScreen'));
        layoutSplitBtn.addEventListener('click', () => setLayout('splitScreen'));

        timerPlayPauseBtn.addEventListener('click', toggleTimer);
        timerResetBtn.addEventListener('click', resetTimer);
        timerSetBtn.addEventListener('click', openTimerSettings);
        cancelTimerSetBtn.addEventListener('click', closeTimerSettings);
        confirmTimerSetBtn.addEventListener('click', setTimerFromInput);

        // Close timer settings modal if the user clicks outside of it
        timerSettingsModal.addEventListener('click', (e) => {
            if (e.target === timerSettingsModal) {
                closeTimerSettings();
            }
        });

        // Audio Player Event Listeners (updated for overlay)
        toggleAudioPlayerBtn.addEventListener('click', toggleCompactAudioPlayer);
        closeCompactAudioPlayerBtn.addEventListener('click', closeCompactAudioPlayer);
        audioLanguageRadios.forEach(radio => {
            radio.addEventListener('change', updateAudioLanguage);
        });


        // Event listener for the back button to return to the previous page in history
        backBtn.addEventListener('click', () => {
            window.history.back();
        });

        // --- Initialization ---
        // Ensures the DOM is fully loaded before running initialization scripts.
        document.addEventListener('DOMContentLoaded', () => {
            // Apply dark mode based on user's system preference for consistency
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.classList.add('dark');
            }
            window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                if (event.matches) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            });

            initializePaperViewer(); // Start the paper viewer setup
        });
    </script>
</body>
</html>
